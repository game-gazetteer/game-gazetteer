<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Game Gazetteer - Metroid Prime 4: Beyond</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2231351762568545"
     crossorigin="anonymous">
  </script>
  <style>

    /* ===== MAP PIN MARKER ===== */
    .marker {
    position: relative;
    width: 34px;
    height: 34px;
    background: #673ab7;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.45);
    border: 2px solid rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    }

    /* Locked state: red outline (only used in edit mode via JS) */
    .marker-locked {
      border-color: rgba(255, 0, 0, 0.95) !important;
    }

    /* SVG icon */
    .marker svg {
        width: 100%;
        height: 100%;
        fill: white;
        z-index: 2;
    }

    /* Found state */
    .marker-found {
    opacity: 0.5;
    filter: grayscale(60%);
    }

    /* Category colors */
    .marker-crystals       { background: blue; }
    .marker-missiles       { background: rgb(0, 131, 131); }
    .marker-shots          { background: #0f1419; }
    .marker-bombs          { background: #5515eb; }
    .marker-bosses         { background: lime; }
    .marker-boosts         { background: #01687D; }
    .marker-energy         { background: orangered; }
    .marker-maps           { background: green; }
    .marker-terminals      { background: #C88A00; }
    .marker-psychic        { background: yellow; }
    .marker-mech           { background: seagreen; }
    .marker-biology        { background: red; }
    .marker-machines       { background: red; }
    .marker-gfed           { background: #ff7043; }
    .marker-research       { background: rgb(195, 0, 255); }
    .marker-logs           { background: #01687D; }
    .marker-save           { background: rgb(136, 255, 0); }
    .marker-keys           { background: #4B0082; }

    .leaflet-container img.leaflet-tile {
        mix-blend-mode: normal;
        width: 256px !important;
        height: 256px !important;
    }

    /* Remove the default popup close button */
    .leaflet-popup-close-button {
    display: none;
    }

    /* Dark mode popup styles */
    .popup-dark .leaflet-popup-content-wrapper {
    background: rgba(30,30,30,0.95) !important;
    color: #ddd;
    border-radius: 8px;
    box-shadow: none;
    border: none;
    }

    .popup-dark .leaflet-popup-tip {
    background: rgba(30,30,30,0.95) !important;
    border: none;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
    }

    #map { 
      width: 100%; height: 100%; 
      background: #01090c;
    }

    /* SIDEBAR */
    #controls {
      position: absolute;
      top: 60px; /* moved down from 20px */
      left: 20px;
      width: 260px;
      max-height: calc(100vh - 80px);
      background: rgba(20,20,20,0.85);
      color: #eee;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 2000;
      display: block;

      overflow-y: auto;  /* enable vertical scrolling */
      scrollbar-width: thin; /* for Firefox */
      scrollbar-color: rgba(255,255,255,0.3) transparent;
    }

    #controls::-webkit-scrollbar {
      width: 8px;
    }

    #controls::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.3);
      border-radius: 4px;
    }

    #controls::-webkit-scrollbar-track {
      background: transparent;
    }

    /* SIDEBAR TOGGLE */
    #toggleSidebar {
      position: absolute;
      top: 20px; /* stays above the sidebar */
      left: 20px;
      z-index: 3000;
      background: rgba(20,20,20,0.85);
      border: none;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toggleSidebar svg {
    display: block;
    }

    #controls h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 600;
    }

    .subcategory { margin-top: 14px; }

    .subcategory h3 {
      margin: 0 0 8px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    .filter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.05);
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .filter-item:hover {
      background: rgba(255,255,255,0.12);
    }

    .filter-icon {
      width: 22px;
      height: 22px;
      fill: white;
      flex-shrink: 0;
    }

    .filter-item span {
      flex-grow: 1;
      margin-left: 10px;
      font-size: 14px;
    }

    /* Toggle Switch (sidebar) */
    .filter-item input[type="checkbox"] {
      appearance: none;
      width: 36px;
      height: 18px;
      background: #555;
      border-radius: 9px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: 0.2s;
    }
    .filter-item input[type="checkbox"]::after {
      content: "";
      width: 14px;
      height: 14px;
      background: #ccc;
      position: absolute;
      top: 2px;
      left: 2px;
      border-radius: 50%;
      transition: 0.2s;
    }
    .filter-item input[type="checkbox"]:checked {
      background: #4caf50;
    }
    .filter-item input[type="checkbox"]:checked::after {
      left: 20px;
      background: white;
    }

    #foundToggle {
      margin-top: 18px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #673ab7;
      color: white;
      font-size: 14px;
    }

    #progressBox {
      background: rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }

    #progressBox h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #fff;
    }

    #progressDetails {
      font-size: 14px;
      opacity: 0.9;
    }

    #progressDetailsContainer.centered {
      justify-content: center; /* center the text when star is hidden */
    }

    /* Progress bar container */
    #progressBarOuter {
      width: 100%;
      height: 14px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      overflow: hidden;
      margin: 8px 0 10px 0;
    }

    /* Animated filling bar */
    #progressBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #9c7cff, #673ab7);
      transition: width 0.35s ease;
      border-radius: 8px;
    }

    #progressStar {
      font-size: 20px;
      filter: drop-shadow(0 0 4px gold);
      display: inline-block; /* will toggle to none in JS */
      transition: transform 0.4s cubic-bezier(.3,1.5,.7,1);
    }

    /* Popup toggle switch */
    .popup-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 6px;
    }
    .popup-toggle input[type="checkbox"] {
      appearance: none;
      width: 28px;
      height: 14px;
      background: #555;
      border-radius: 7px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: 0.2s;
    }
    .popup-toggle input[type="checkbox"]::after {
      content: "";
      width: 12px;
      height: 12px;
      background: #2196F3; /* blue toggle */
      position: absolute;
      top: 1px;
      left: 1px;
      border-radius: 50%;
      transition: 0.2s;
    }
    .popup-toggle input[type="checkbox"]:checked {
      background: #2196F3;
    }
    .popup-toggle input[type="checkbox"]:checked::after {
      left: 15px;
      background: white;
    }

    .collapsible-header {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .subcategory-content {
      overflow: hidden;
      max-height: 500px;
      transition: max-height 0.25s ease;
    }

    .subcategory.collapsed .subcategory-content {
      max-height: 0;
    }

    /* ------------------------------
      MOBILE RESPONSIVE SIDEBAR
    --------------------------------*/
    @media (max-width: 768px) {
      #controls {
        width: 70%;             /* shrinks sidebar */
        left: 10px;
        top: 70px;
        padding: 14px;
        border-radius: 12px;
        font-size: 14px;
      }

      #toggleSidebar {
        top: 10px;
        left: 10px;
        padding: 6px;
        transform: scale(0.9);
      }

      #controls h2 {
        font-size: 18px;
      }

      .subcategory h3 {
        font-size: 14px;
      }

      .filter-item span {
        font-size: 13px;
      }

      .filter-item {
        padding: 4px 6px;
      }

      #foundToggle,
      #resetProgress,
      #showAllBtn,
      #hideAllBtn {
        font-size: 13px;
        padding: 8px;
      }

      #markerSearch {
        font-size: 13px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      #controls {
        width: 85%;
        padding: 12px;
        left: 8px;
        top: 65px;
      }

      #toggleSidebar {
        transform: scale(0.8);
      }

      .filter-item {
        padding: 4px 5px;
      }
    }

  </style>
</head>

<body>

<button id="toggleSidebar" title="Toggle Sidebar">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="3" y1="6" x2="21" y2="6"/>
    <line x1="3" y1="12" x2="21" y2="12"/>
    <line x1="3" y1="18" x2="21" y2="18"/>
  </svg>
</button> 

<div id="controls">

  <a href="https://www.gamegazetteer.com" id="gazetteerBtn" style="
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: white;
    padding: 4px 0px;
    border-radius: 8px;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 28px;
    font-family: 'Cinzel', serif;
  ">
    <img src="favicon.png" alt="Logo" style="width:32px; height:32px;">
    Game Gazetteer
  </a>



  <input type="text" id="markerSearch" placeholder="Search..." style="
    width: calc(100% - 16px);
    padding: 6px 8px;
    border-radius: 6px;
    border: none;
    outline: none;
    font-size: 14px;
    margin-bottom: 10px;
    display: block;
  ">

  <div id="toggleAllContainer" style="display:flex; gap:8px; margin-top:10px;">
      <button id="showAllBtn" style="
          flex:1;
          padding:8px;
          border:none;
          border-radius:8px;
          cursor:pointer;
          background: #673ab7;  /* same purple */
          color:white;
          font-size:14px;
      ">Show All</button>

      <button id="hideAllBtn" style="
          flex:1;
          padding:8px;
          border:none;
          border-radius:8px;
          cursor:pointer;
          background: #673ab7;  /* same purple */
          color:white;
          font-size:14px;
      ">Hide All</button>
  </div>

  <!-- COLLECTIBLES -->
  <div class="subcategory">
    <h3 class="collapsible-header">Collectibles</h3>
      <div class="subcategory-content">
        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <!-- Outer crystal -->
            <polygon points="32,4 52,22 40,58 24,58 12,22" />

            <!-- Inner facets -->
            <line x1="32" y1="4" x2="32" y2="58" />
            <line x1="32" y1="4" x2="40" y2="24" />
            <line x1="32" y1="4" x2="24" y2="24" />
          </svg>

          <span>Green Energy Crystals</span>
          <input type="checkbox" class="category" value="crystals" checked>
        </label>

        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Missile"
          >
            <!-- Nose -->
            <path
              d="M32 4
                C26 10, 22 16, 22 22
                H42
                C42 16, 38 10, 32 4 Z"
            />

            <!-- Main Body -->
            <rect
              x="22"
              y="22"
              width="20"
              height="28"
              rx="6"
            />

            <!-- Panel lines -->
            <line x1="26" y1="28" x2="38" y2="28" />
            <line x1="26" y1="34" x2="38" y2="34" />
            <line x1="26" y1="40" x2="38" y2="40" />

            <!-- Left fin -->
            <path d="M20 46 H28 V52 L24 58 L20 52 Z" />

            <!-- Right fin -->
            <path d="M36 46 H44 V52 L40 58 L36 52 Z" />

            <!-- Exhaust -->
            <rect
              x="26"
              y="50"
              width="12"
              height="6"
              rx="2"
            />
          </svg>
          <span>Missile Expansions</span>
          <input type="checkbox" class="category" value="missiles" checked>
        </label>

        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 128 128"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Target / Energy Core"
          >
            <!-- Outer ring -->
            <circle cx="64" cy="64" r="50" />

            <!-- Inner ring -->
            <circle cx="64" cy="64" r="28" />

            <!-- Crosshair + diagonals -->
            <path d="M64 14 L64 114" />
            <path d="M14 64 L114 64" />
            <path d="M36 36 L92 92" />
            <path d="M36 92 L92 36" />

            <!-- Core -->
            <circle cx="64" cy="64" r="12" />
          </svg>
          <span>Shot Expansion/Upgrade</span>
          <input type="checkbox" class="category" value="shots" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
            width="28" height="28" fill="none" stroke="currentColor"
            stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
            aria-label="Power Bomb Expansion">

            <!-- Outer blast ring -->
            <circle cx="32" cy="32" r="20"/>

            <!-- Simple bomb body -->
            <circle cx="32" cy="34" r="10"/>

            <!-- Fuse -->
            <path d="M32 24 V18"/>
            <path d="M28 18 H36"/>

            <!-- Energy sparks -->
            <path d="M32 8  V14"/>
            <path d="M32 50 V56"/>
            <path d="M8  32 H14"/>
            <path d="M50 32 H56"/>

            <path d="M14 14 L18 18"/>
            <path d="M46 46 L50 50"/>
            <path d="M14 50 L18 46"/>
            <path d="M46 18 L50 14"/>
          </svg>
          <span>Power Bomb Expansion</span>
          <input type="checkbox" class="category" value="bombs" checked>
        </label>

        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 150 150"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Artifact Orb"
          >
            <!-- Outer orb -->
            <circle cx="75" cy="75" r="50" />

            <!-- Spiral paths -->
            <g transform="rotate(-15 75 75)">
              <path d="M10 75 C50 10 100 140 140 75" />
              <path d="M10 75 C50 140 100 10 140 75" />
            </g>

            <!-- Top platform -->
            <path
              d="M36 24
                Q30 30 36 36
                H114
                Q120 30 114 24
                Z"
            />

            <!-- Bottom platform -->
            <path
              d="M36 114
                Q30 120 36 126
                H114
                Q120 120 114 114
                Z"
            />
          </svg>
          <span>Vi-O-La Boost Tanks</span>
          <input type="checkbox" class="category" value="boosts" checked>
        </label>

        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Energy Canister"
          >
            <!-- Left cap -->
            <ellipse cx="16" cy="32" rx="6" ry="18" />

            <!-- Right cap -->
            <ellipse cx="48" cy="32" rx="6" ry="18" />

            <!-- Outer shell -->
            <rect
              x="16"
              y="16"
              width="32"
              height="32"
              rx="12"
            />

            <!-- Inner energy core -->
            <rect
              x="18"
              y="18"
              width="28"
              height="28"
              rx="10"
            />

            <!-- Energy lines -->
            <line x1="22" y1="26" x2="42" y2="26" />
            <line x1="22" y1="32" x2="42" y2="32" />
            <line x1="22" y1="38" x2="42" y2="38" />
          </svg>
          <span>Energy Tanks</span>
          <input type="checkbox" class="category" value="energy" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="3.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Psychic Abilities">

            <!-- Outer ring -->
            <circle cx="32" cy="32" r="22"/>

            <!-- Inner ring -->
            <circle cx="32" cy="32" r="12"/>

            <!-- Psychic waves -->
            <path d="M18 34 C22 26, 30 24, 32 18"/>
            <path d="M46 34 C42 26, 34 24, 32 18"/>

            <!-- Core -->
            <circle cx="32" cy="36" r="6"/>

          </svg>
          <span>Psychic Abilities</span>
          <input type="checkbox" class="category" value="psychic" checked>
        </label>

        <label class="filter-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            aria-label="Key"
          >
            <!-- Key head -->
            <circle
              cx="20"
              cy="32"
              r="12"
              fill="none"
              stroke="white"
              stroke-width="4"
            />

            <!-- Head hole -->
            <circle
              cx="20"
              cy="32"
              r="4"
              fill="none"
              stroke="white"
              stroke-width="3"
            />

            <!-- Shaft -->
            <rect
              x="32"
              y="28"
              width="20"
              height="8"
              fill="white"
            />

            <!-- Teeth -->
            <rect x="46" y="36" width="6" height="8" fill="white"/>
            <rect x="38" y="36" width="6" height="5" fill="white"/>
          </svg>
          <span>Master Teleporter Keys</span>
          <input type="checkbox" class="category" value="keys" checked>
        </label>

      </div>
  </div>

  <!-- Scan Logbook -->
  <div class="subcategory">
    <h3 class="collapsible-header">Scan Logbook</h3>
      <div class="subcategory-content">

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 12c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>
          <span>Galactic Federation</span>
          <input type="checkbox" class="category" value="gfed" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 128 128"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="8"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Boss">

            <!-- Outer shell -->
            <path d="M64 16
                    C48 16 38 24 34 36
                    C26 40 22 48 22 58
                    C22 74 34 88 48 98
                    C54 110 74 110 80 98
                    C94 88 106 74 106 58
                    C106 48 102 40 94 36
                    C90 24 80 16 64 16 Z"/>

            <!-- Horns -->
            <path d="M34 44 L18 36 L22 54 Z"/>
            <path d="M94 44 L110 36 L106 54 Z"/>

            <!-- Crown -->
            <path d="M48 40 L64 30 L80 40"/>

            <!-- Core -->
            <circle cx="64" cy="58" r="14"/>

            <!-- Lower chevrons -->
            <path d="M50 80 L64 88 L78 80"/>
            <path d="M54 94 L64 100 L74 94"/>

          </svg>
          <span>Bosses</span>
          <input type="checkbox" class="category" value="bosses" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="12 16 40 44"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Biology Creature">

            <!-- Fins -->
            <path
              d="M18 28 C20 30 23 33 24 36
                C22 36 19 35 17 32 Z"
            />
            <path
              d="M46 28 C44 30 41 33 40 36
                C42 36 45 35 47 32 Z"
            />

            <!-- Face plate -->
            <ellipse
              cx="32"
              cy="32"
              rx="9"
              ry="7"
            />

            <!-- Core -->
            <circle
              cx="32"
              cy="42"
              r="5"
            />

            <!-- Eyes -->
            <circle cx="29" cy="32" r="1.5"/>
            <circle cx="35" cy="32" r="1.5"/>

          </svg>
          <span>Biology</span>
          <input type="checkbox" class="category" value="biology" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28" height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Enemy (Drone)">
            
            <!-- Outer shell -->
            <path d="M32 8
                    C22 8 15 15 15 25
                    C15 38 23 48 32 56
                    C41 48 49 38 49 25
                    C49 15 42 8 32 8 Z"/>

            <!-- Side fins -->
            <path d="M15 27 L8 31 L15 35 Z"/>
            <path d="M49 27 L56 31 L49 35 Z"/>

            <!-- Faceplate -->
            <path d="M32 15
                    C25 15 20 20 20 27
                    C20 35 25 42 32 47
                    C39 42 44 35 44 27
                    C44 20 39 15 32 15 Z"/>

            <!-- Eye -->
            <circle cx="32" cy="27" r="4.5"/>

            <!-- Threat chevron -->
            <path d="M24 38 L32 43 L40 38"/>

            <!-- Danger node -->
            <circle cx="32" cy="54" r="2.8"/>
          </svg>
          <span>Machines</span>
          <input type="checkbox" class="category" value="machines" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 12c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>
          <span>Lamorn Lore</span>
          <input type="checkbox" class="category" value="lore" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            aria-label="Data Disc"
            fill="none"
            stroke="currentColor"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round">

            <!-- Outer disc (slightly smaller so it breathes) -->
            <circle cx="32" cy="32" r="22"/>

            <!-- Segmented ring -->
            <path d="M32 16 A16 16 0 0 1 46 24"/>
            <path d="M48 32 A16 16 0 0 1 40 46"/>
            <path d="M32 48 A16 16 0 0 1 18 40"/>
            <path d="M16 32 A16 16 0 0 1 24 18"/>

            <!-- Inner ring -->
            <circle cx="32" cy="32" r="9"/>

            <!-- Center hub -->
            <circle cx="32" cy="32" r="3"/>

          </svg>
          <span>Data Logs</span>
          <input type="checkbox" class="category" value="logs" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
            width="28" height="28" fill="none" stroke="currentColor"
            stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
            aria-label="Research Sample">

            <!-- Flask outline -->
            <path d="M26 6 H38"/>
            <path d="M30 6 V18 L18 40 A8 8 0 0 0 26 52 H38 A8 8 0 0 0 46 40 L34 18 V6"/>

            <!-- Fluid level -->
            <line x1="24" y1="36" x2="40" y2="36"/>

            <!-- Bubbles -->
            <circle cx="30" cy="30" r="1.5"/>
            <circle cx="34" cy="26" r="1.5"/>
          </svg>
          <span>Research</span>
          <input type="checkbox" class="category" value="research" checked>
        </label>
      </div>
  </div>

  <!-- POINTS OF INTEREST -->
  <div class="subcategory">
    <h3 class="collapsible-header">Points of Interest</h3>
      <div class="subcategory-content">

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
            width="28" height="28" fill="none" stroke="currentColor"
            stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
            aria-label="Map (folded)">

            <!-- Folded map outline -->
            <path d="M14 18 L26 14 L38 18 L50 14 V46 L38 50 L26 46 L14 50 Z"/>

            <!-- Panel folds -->
            <path d="M26 14 V46"/>
            <path d="M38 18 V50"/>

            <!-- Route line -->
            <path d="M18 40 C24 30, 30 34, 36 26 S46 22, 46 30"/>

            <!-- Location node -->
            <circle cx="46" cy="30" r="3"/>
          </svg>
          <span>Area Maps</span>
          <input type="checkbox" class="category" value="maps" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
            width="28" height="28" fill="none" stroke="currentColor"
            stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
            aria-label="Mech Part (Plate)">
            <!-- Plate -->
            <path d="M16 14 H48 L54 24 V40 L48 50 H16 L10 40 V24 Z"/>

            <!-- Inner panel -->
            <path d="M22 22 H42 L46 28 V36 L42 42 H22 L18 36 V28 Z"/>

            <!-- Mounting holes -->
            <circle cx="18" cy="24" r="2"/>
            <circle cx="46" cy="24" r="2"/>
            <circle cx="18" cy="40" r="2"/>
            <circle cx="46" cy="40" r="2"/>

            <!-- Vent slots -->
            <line x1="26" y1="30" x2="38" y2="30"/>
            <line x1="26" y1="34" x2="38" y2="34"/>
          </svg>
          <span>Mech Parts</span>
          <input type="checkbox" class="category" value="mech" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="3.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Terminal">

            <!-- Main body -->
            <rect x="16" y="18" width="32" height="30" rx="4"/>

            <!-- Inner panel -->
            <rect x="20" y="22" width="24" height="22" rx="2"/>

            <!-- Buttons row 1 -->
            <circle cx="26" cy="30" r="2"/>
            <circle cx="32" cy="30" r="2"/>
            <circle cx="38" cy="30" r="2"/>

            <!-- Buttons row 2 -->
            <circle cx="26" cy="36" r="2"/>
            <circle cx="32" cy="36" r="2"/>
            <circle cx="38" cy="36" r="2"/>

            <!-- Bottom base -->
            <rect x="20" y="50" width="24" height="4" rx="1"/>

          </svg>
          <span>Terminals</span>
          <input type="checkbox" class="category" value="terminals" checked>
        </label>

        <label class="filter-item">
          <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 64 64"
            width="28"
            height="28"
            fill="none"
            stroke="currentColor"
            stroke-width="3.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-label="Save Station">

            <!-- Top cap -->
            <rect x="22" y="6" width="20" height="8" rx="4"/>

            <!-- Main tube -->
            <rect x="20" y="12" width="24" height="36" rx="12"/>

            <!-- Inner core -->
            <rect x="29" y="18" width="6" height="24" rx="3"/>

            <!-- Bottom base -->
            <rect x="18" y="48" width="28" height="8" rx="3"/>

          </svg>
          <span>Save Stations</span>
          <input type="checkbox" class="category" value="save" checked>
        </label>
      </div>
  </div>

  <!-- PROGRESS COUNTER (moved to bottom) -->
  <div id="progressBox">
    <h3>Progress</h3>

    <div id="progressBarOuter">
      <div id="progressBarInner"></div>
    </div>

    <div id="progressDetailsContainer" style="display:flex; align-items:center; justify-content:center; gap:6px; margin-top:4px;">
      <div id="progressDetails">0 / 0 (0%)</div>
      <div id="progressStar">⭐</div>
    </div>

  </div>

  <button id="foundToggle">Hide Found Items</button>

  <button id="resetProgress" style="
    margin-top: 10px;
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #e53935; /* red */
    color: white;
    font-size: 14px;
  ">Reset Progress</button>

</div>

<div id="map"></div>

<button id="exportMarkers" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 99999;
  padding: 10px 14px;
  border-radius: 10px;
  background: #673ab7;
  color: white;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: none;
">
  Export Marker JSON
</button>


<select id="layerSelect" style="
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 3000;

  padding: 6px 14px;
  border-radius: 10px;
  background: rgba(20,20,20,0.85);
  color: white;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
">
  <option value="viewros">Viewros</option>
  <option value="dungeons">Dungeons</option>
</select>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const forcedVisibleMarkers = new Set();

// ============================
// EDIT MODE GLOBALS
// Use: ?edit=true
// ============================
window.GG_EDIT_MODE = new URLSearchParams(window.location.search).get("edit") === "true";

// This will hold the raw JSON array (metroid-prime-4-markers.json)
// We set it later after fetch loads.
window.GG_MARKER_DATA = [];

// A function we will define later (inside module script) to add markers on click.
window.GG_ADD_MARKER_AT = null;
window.GG_PENDING_ADD_LATLNGS = [];

// ============================
// EDIT MODE: Link Mode
// ============================
window.GG_LINKING_FROM = null; // marker object when "link mode" is active

function toast(msg) {
  // super-lightweight toast; swap with alert() if you want
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.position = "fixed";
  el.style.left = "50%";
  el.style.bottom = "28px";
  el.style.transform = "translateX(-50%)";
  el.style.padding = "10px 14px";
  el.style.borderRadius = "12px";
  el.style.background = "rgba(20,20,20,0.90)";
  el.style.color = "white";
  el.style.fontWeight = "700";
  el.style.zIndex = "999999";
  el.style.border = "1px solid rgba(255,255,255,0.15)";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1800);
}

// ESC cancels link mode
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && window.GG_LINKING_FROM) {
    window.GG_LINKING_FROM = null;
    toast("Link mode cancelled");
  }
});

function addLink(fromMarker, toMarker) {
  if (!fromMarker || !toMarker) return;
  if (fromMarker.__id === toMarker.__id) return;

  // Ensure backing array exists
  const p = fromMarker.__dataRef;
  if (!p) return;
  p.links = Array.isArray(p.links) ? p.links : [];

  // Avoid duplicates
  const exists = p.links.some(l => String(l.target) === String(toMarker.__id));
  if (exists) return;

  const label = toMarker.options?.title || toMarker.__id;

  // Use current zoom as a sensible default
  const zoom = map.getZoom();

  p.links.push({ label, target: toMarker.__id, zoom });

  // Keep the live Leaflet marker in sync too
  fromMarker.links = p.links;

  // Rebuild popup so the "Related" list updates immediately
  createMarkerPopup(fromMarker, fromMarker.__id);
}

function removeLink(fromMarker, targetId) {
  const p = fromMarker?.__dataRef;
  if (!p || !Array.isArray(p.links)) return;

  p.links = p.links.filter(l => String(l.target) !== String(targetId));
  fromMarker.links = p.links;

  createMarkerPopup(fromMarker, fromMarker.__id);
}

// Show export button in edit mode and wire export
(function initEditorUI() {
  const btn = document.getElementById("exportMarkers");
  if (!btn) return;

  if (window.GG_EDIT_MODE) {
    btn.style.display = "block";
    btn.addEventListener("click", async () => {
      // Sort a COPY for export (doesn't affect your live array order)
      const sorted = [...window.GG_MARKER_DATA].sort((a, b) => {
        // Sort by full id (layer:id) so it’s deterministic across layers
        const ak = `${a.layer ?? ""}:${String(a.id ?? "")}`;
        const bk = `${b.layer ?? ""}:${String(b.id ?? "")}`;

        // numeric:true makes "c2" come before "c10"
        return ak.localeCompare(bk, undefined, { numeric: true, sensitivity: "base" });
      });

      const json = JSON.stringify(sorted, null, 2);

      try {
        await navigator.clipboard.writeText(json);
        alert("Marker JSON (sorted) copied to clipboard!");
      } catch (err) {
        console.log(json);
        alert("Clipboard blocked — sorted JSON printed to console.");
      }

      console.log(json);
    });
  }
})();


const SVG_ICONS = {
  crystals: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <defs>
        <!-- Glow gradient -->
        <radialGradient id="coreGlow" cx="50%" cy="35%" r="60%">
          <stop offset="0%" stop-color="#b6ffb6"/>
          <stop offset="50%" stop-color="#32ff6a"/>
          <stop offset="100%" stop-color="#0b5f2a"/>
        </radialGradient>

        <!-- Outer crystal gradient -->
        <linearGradient id="crystalBody" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#7dffb0"/>
          <stop offset="100%" stop-color="#1a7f46"/>
        </linearGradient>

        <!-- Soft glow -->
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Glow aura -->
      <polygon
        points="32,4 52,22 40,58 24,58 12,22"
        fill="url(#coreGlow)"
        opacity="0.6"
        filter="url(#glow)"
      />

      <!-- Crystal body -->
      <polygon
        points="32,6 50,22 38,56 26,56 14,22"
        fill="url(#crystalBody)"
        stroke="#b6ffd1"
        stroke-width="1.5"
      />

      <!-- Facet highlights -->
      <polygon points="32,6 40,24 32,56" fill="#aaffcc" opacity="0.35"/>
      <polygon points="32,6 24,24 32,56" fill="#4fdc8c" opacity="0.35"/>

    </svg>

  `,
  missiles: `
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 64 64"
      width="64"
      height="64"
    >
      <!-- Missile Body -->
      <defs>
        <linearGradient id="missileGradient" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#ffeb3b"/>
          <stop offset="100%" stop-color="#f0c000"/>
        </linearGradient>
      </defs>

      <!-- Nose -->
      <path
        d="M32 4
          C26 10, 22 16, 22 22
          L42 22
          C42 16, 38 10, 32 4 Z"
        fill="#fff176"
      />

      <!-- Main Body -->
      <rect
        x="22"
        y="22"
        width="20"
        height="28"
        rx="6"
        fill="url(#missileGradient)"
      />

      <!-- Panel Lines -->
      <line x1="26" y1="26" x2="38" y2="26" stroke="#fff9c4" stroke-width="1"/>
      <line x1="26" y1="32" x2="38" y2="32" stroke="#fff9c4" stroke-width="1"/>
      <line x1="26" y1="38" x2="38" y2="38" stroke="#fff9c4" stroke-width="1"/>

      <!-- Fins -->
      <rect x="20" y="46" width="8" height="6" fill="#b38f00"/>
      <polygon points="20,52 24,58 28,52" fill="#b38f00"/>

      <rect x="36" y="46" width="8" height="6" fill="#b38f00"/>
      <polygon points="36,52 40,58 44,52" fill="#b38f00"/>

      <!-- Exhaust -->
      <rect
        x="26"
        y="50"
        width="12"
        height="6"
        rx="2"
        fill="#3b0b0b"
      />
    </svg>
  `,
  shotsice: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128" width="128" height="128">
      <circle cx="64" cy="64" r="50" fill="#0bc1e3" stroke="#009bb0" stroke-width="6"/>
      <circle cx="64" cy="64" r="28" fill="#00f0ff" stroke="#00a2c1" stroke-width="4"/>
      <path d="M64 10 L64 118 M10 64 L118 64 M36 36 L92 92 M36 92 L92 36" 
            stroke="#7ef0ff" stroke-width="4" stroke-linecap="round"/>
      <circle cx="64" cy="64" r="12" fill="#00ffff" stroke="#0bc1e3" stroke-width="2"/>
    </svg>
  `,
  shotsfire: `
    <svg xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 128 128"
        width="128"
        height="128">
      <!-- Outer ring -->
      <circle
        cx="64" cy="64" r="50"
        fill="#e53935"
        stroke="#b71c1c"
        stroke-width="6"
      />

      <!-- Inner ring -->
      <circle
        cx="64" cy="64" r="28"
        fill="#ff6f60"
        stroke="#c62828"
        stroke-width="4"
      />

      <!-- Cross + diagonals -->
      <path
        d="M64 10 L64 118
          M10 64 L118 64
          M36 36 L92 92
          M36 92 L92 36"
        stroke="#ffcdd2"
        stroke-width="4"
        stroke-linecap="round"
      />

      <!-- Core -->
      <circle
        cx="64" cy="64" r="12"
        fill="#ff8a80"
        stroke="#e53935"
        stroke-width="2"
      />
    </svg>
  `,
  shotsthunder: `
    <svg xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 128 128"
        width="128"
        height="128">
      <!-- Outer ring -->
      <circle
        cx="64" cy="64" r="50"
        fill="#fdd835"
        stroke="#f9a825"
        stroke-width="6"
      />

      <!-- Inner ring -->
      <circle
        cx="64" cy="64" r="28"
        fill="#fff176"
        stroke="#fbc02d"
        stroke-width="4"
      />

      <!-- Cross + diagonals (electric glow lines) -->
      <path
        d="M64 10 L64 118
          M10 64 L118 64
          M36 36 L92 92
          M36 92 L92 36"
        stroke="#fffde7"
        stroke-width="4"
        stroke-linecap="round"
      />

      <!-- Core -->
      <circle
        cx="64" cy="64" r="12"
        fill="#ffff8d"
        stroke="#fdd835"
        stroke-width="2"
      />
    </svg>
  `,
  boosts: `
    <svg width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg">
      <!-- Background circle glow -->
      <circle cx="75" cy="75" r="50" fill="url(#pinkGradient)" />
      
      <!-- Pink orb center -->
      <defs>
        <radialGradient id="pinkGradient" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#ffb3d9"/>
          <stop offset="100%" stop-color="#ff80c0"/>
        </radialGradient>
        
        <!-- Golden spiral path -->
        <path id="spiralPath" d="M10,75 C50,10 100,140 140,75" fill="none"/>
      </defs>
      
      <!-- Golden spirals angled diagonally -->
      <g
        stroke="#D4AF37"
        stroke-width="8"
        stroke-linecap="round"
        stroke-linejoin="round"
        fill="none"
        transform="rotate(-15 75 75)"
      >
        <use href="#spiralPath" />
        <use href="#spiralPath" transform="scale(1,-1) translate(0,-150)" />
      </g>
      
      <!-- Top gold platform (subtle semi-circle edges) -->
      <path
        d="
          M36,20
          Q30,26 36,32
          L114,32
          Q120,26 114,20
          Z"
        fill="#D4AF37"
      />

      <!-- Bottom gold platform (subtle semi-circle edges) -->
      <path
        d="
          M36,118
          Q30,124 36,130
          L114,130
          Q120,124 114,118
          Z"
        fill="#D4AF37"
      />

    </svg>
  `,
  energy: `
    <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <!-- Cyan energy -->
        <linearGradient id="energyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#AFFFFF"/>
          <stop offset="100%" stop-color="#2CFFFF"/>
        </linearGradient>

        <!-- Blue canister shell -->
        <linearGradient id="shellGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#1E3F66"/>
          <stop offset="50%" stop-color="#3B6FA5"/>
          <stop offset="100%" stop-color="#16304D"/>
        </linearGradient>

        <filter id="energyGlow">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Left cap (behind) -->
      <ellipse cx="16" cy="32" rx="6" ry="18" fill="#234E7A"/>

      <!-- Right cap (behind) -->
      <ellipse cx="48" cy="32" rx="6" ry="18" fill="#234E7A"/>

      <!-- Energy core (in front) -->
      <rect x="18" y="18" width="28" height="28" rx="10"
            fill="url(#energyGrad)"
            filter="url(#energyGlow)"/>

      <!-- Shell frame (in front of caps, around core) -->
      <rect x="16" y="16" width="32" height="32" rx="12"
            fill="none"
            stroke="url(#shellGrad)"
            stroke-width="4"/>

      <!-- Horizontal energy lines -->
      <g stroke="#EFFFFF" stroke-width="1.5" opacity="0.85">
        <line x1="22" y1="26" x2="42" y2="26"/>
        <line x1="22" y1="32" x2="42" y2="32"/>
        <line x1="22" y1="38" x2="42" y2="38"/>
      </g>
    </svg>
  `,
  maps: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
      width="28" height="28" fill="none" stroke="currentColor"
      stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
      aria-label="Map (folded)">

      <!-- Folded map outline -->
      <path d="M14 18 L26 14 L38 18 L50 14 V46 L38 50 L26 46 L14 50 Z"/>

      <!-- Panel folds -->
      <path d="M26 14 V46"/>
      <path d="M38 18 V50"/>

      <!-- Route line -->
      <path d="M18 40 C24 30, 30 34, 36 26 S46 22, 46 30"/>

      <!-- Location node -->
      <circle cx="46" cy="30" r="3"/>
    </svg>
  `,
  machines: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128" role="img" aria-label="Enemy icon">
      <defs>
        <style>
          :root{
            --stroke:#0b1220;
            --body1:#1e2b45;
            --body2:#0f1830;
            --glow:#49f2ff;
            --accent:#ff6b6b;
          }
          .s{stroke:var(--stroke);stroke-width:4;stroke-linecap:round;stroke-linejoin:round}
        </style>

        <linearGradient id="gBody" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="var(--body1)"/>
          <stop offset="1" stop-color="var(--body2)"/>
        </linearGradient>

        <radialGradient id="gEye" cx="50%" cy="50%" r="60%">
          <stop offset="0" stop-color="#ffffff" stop-opacity="0.9"/>
          <stop offset="0.35" stop-color="var(--glow)" stop-opacity="0.95"/>
          <stop offset="1" stop-color="var(--glow)" stop-opacity="0"/>
        </radialGradient>

        <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="2.5" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Outer shell -->
      <path class="s" fill="url(#gBody)"
            d="M64 16
              C42 16 26 32 26 52
              C26 78 44 98 64 112
              C84 98 102 78 102 52
              C102 32 86 16 64 16 Z"/>

      <!-- Side fins -->
      <path class="s" fill="var(--body2)"
            d="M26 54 L12 62 L26 70 Z"/>
      <path class="s" fill="var(--body2)"
            d="M102 54 L116 62 L102 70 Z"/>

      <!-- Inner faceplate -->
      <path class="s" fill="#0a1023"
            d="M64 30
              C49 30 38 41 38 56
              C38 73 50 87 64 96
              C78 87 90 73 90 56
              C90 41 79 30 64 30 Z"/>

      <!-- Eye glow -->
      <circle cx="64" cy="56" r="18" fill="url(#gEye)" filter="url(#softGlow)"/>

      <!-- Eye core -->
      <circle class="s" cx="64" cy="56" r="9" fill="var(--glow)"/>
      <circle cx="61" cy="53" r="2.5" fill="#ffffff" opacity="0.9"/>

      <!-- "Threat" chevrons -->
      <path class="s" fill="none" d="M50 74 L64 82 L78 74" opacity="0.75"/>
      <path class="s" fill="none" d="M54 88 L64 94 L74 88" opacity="0.5"/>

      <!-- Small danger node -->
      <circle class="s" cx="64" cy="106" r="6" fill="var(--accent)"/>
    </svg>
  `,
  biology: `
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="12 16 40 44"
      aria-label="Biology Creature">

      <defs>
        <radialGradient id="bioCoreGrad" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#eafff7"/>
          <stop offset="50%" stop-color="#7bffd0"/>
          <stop offset="100%" stop-color="#00b86b"/>
        </radialGradient>

        <filter id="bioGlow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="2.5" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Fins -->
      <path
        d="M18 26 C20 28 23 31 24 34
          C22 34 19 33 17 30 Z"
        fill="#0f5f3a"
      />
      <path
        d="M46 26 C44 28 41 31 40 34
          C42 34 45 33 47 30 Z"
        fill="#0f5f3a"
      />

      <!-- Face plate -->
      <ellipse
        cx="32"
        cy="30"
        rx="9"
        ry="7"
        fill="#06311f"
        opacity="0.9"
      />

      <!-- Core -->
      <circle
        cx="32"
        cy="40"
        r="5"
        fill="url(#bioCoreGrad)"
        filter="url(#bioGlow)"
      />

      <!-- Eye highlights -->
      <circle cx="29" cy="30" r="1.5" fill="#d9fff1"/>
      <circle cx="35" cy="30" r="1.5" fill="#d9fff1"/>

    </svg>
  `,
  terminals: `
    <svg width="64" height="64" viewBox="0 0 64 64"
        xmlns="http://www.w3.org/2000/svg">

      <defs>
        <linearGradient id="baseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#2C3A5E"/>
          <stop offset="50%" stop-color="#1E2A45"/>
          <stop offset="100%" stop-color="#121C30"/>
        </linearGradient>

        <radialGradient id="buttonGrad" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#FFFF4D"/>
          <stop offset="100%" stop-color="#FFD700" stop-opacity="0.7"/>
        </radialGradient>
      </defs>

      <!-- Scale up around center -->
      <g transform="translate(32,25) scale(1.3) translate(-32,-32)">

        <!-- Terminal main body -->
        <rect x="16" y="20" width="32" height="32" rx="4"
              fill="url(#baseGrad)" stroke="#0A1220" stroke-width="1.5"/>

        <!-- Front panel inset -->
        <rect x="20" y="24" width="24" height="24" rx="2"
              fill="#1C2A45" stroke="#0A1220" stroke-width="1"/>

        <!-- Buttons row 1 -->
        <circle cx="26" cy="30" r="1.8" fill="url(#buttonGrad)"/>
        <circle cx="32" cy="30" r="1.8" fill="url(#buttonGrad)"/>
        <circle cx="38" cy="30" r="1.8" fill="url(#buttonGrad)"/>

        <!-- Buttons row 2 -->
        <circle cx="26" cy="36" r="1.8" fill="url(#buttonGrad)"/>
        <circle cx="32" cy="36" r="1.8" fill="url(#buttonGrad)"/>
        <circle cx="38" cy="36" r="1.8" fill="url(#buttonGrad)"/>

        <!-- Indicator lights -->
        <circle cx="22" cy="42" r="1" fill="#FF5555"/>
        <circle cx="32" cy="42" r="1" fill="#55FF55"/>
        <circle cx="42" cy="42" r="1" fill="#5555FF"/>

        <!-- Vent lines -->
        <line x1="22" y1="24" x2="42" y2="24" stroke="#0A1220" stroke-width="1"/>
        <line x1="22" y1="26" x2="42" y2="26" stroke="#0A1220" stroke-width="1"/>

        <!-- Base/platform -->
        <rect x="18" y="52" width="28" height="4" rx="1" fill="#1E2A45"/>

      </g>
    </svg>
  `,
  psychic: `
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 64 64"
      aria-label="Psychic Abilities">

      <defs>
        <!-- Aura gradient -->
        <radialGradient id="psyAura" cx="50%" cy="45%" r="65%">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="0.85"/>
          <stop offset="35%" stop-color="#b86bff" stop-opacity="0.9"/>
          <stop offset="70%" stop-color="#6d28ff" stop-opacity="0.55"/>
          <stop offset="100%" stop-color="#2a0b6d" stop-opacity="0"/>
        </radialGradient>

        <!-- Core gradient -->
        <radialGradient id="psyCore" cx="50%" cy="40%" r="70%">
          <stop offset="0%" stop-color="#f6f2ff"/>
          <stop offset="45%" stop-color="#b86bff"/>
          <stop offset="100%" stop-color="#5b21b6"/>
        </radialGradient>

        <!-- Soft glow -->
        <filter id="psyGlow" x="-60%" y="-60%" width="220%" height="220%">
          <feGaussianBlur stdDeviation="2.2" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>

        <!-- Outer ring gradient -->
        <linearGradient id="psyRing" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#e9d5ff"/>
          <stop offset="100%" stop-color="#7c3aed"/>
        </linearGradient>
      </defs>

      <!-- Aura -->
      <circle cx="32" cy="32" r="28" fill="url(#psyAura)" filter="url(#psyGlow)"/>

      <!-- Outer ring -->
      <circle cx="32" cy="32" r="22"
        fill="none" stroke="url(#psyRing)" stroke-width="3" opacity="0.95"/>

      <!-- Inner ring -->
      <circle cx="32" cy="32" r="13"
        fill="none" stroke="#c084fc" stroke-width="2" opacity="0.9"/>

      <!-- Psychic waves -->
      <path d="M18 34 C22 26, 30 24, 32 18"
        fill="none" stroke="#a78bfa" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
      <path d="M46 34 C42 26, 34 24, 32 18"
        fill="none" stroke="#a78bfa" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>

      <!-- Core -->
      <circle cx="32" cy="36" r="7" fill="url(#psyCore)" filter="url(#psyGlow)"/>

      <!-- Spark highlights -->
      <circle cx="29" cy="34" r="1.2" fill="#ffffff" opacity="0.9"/>
      <circle cx="36.5" cy="36.5" r="1" fill="#ffffff" opacity="0.75"/>
      <circle cx="33" cy="32" r="0.9" fill="#ffffff" opacity="0.65"/>

    </svg>
  `,
  mech: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
      width="28" height="28" fill="none" stroke="currentColor"
      stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
      aria-label="Mech Part (Plate)">
      <!-- Plate -->
      <path d="M16 14 H48 L54 24 V40 L48 50 H16 L10 40 V24 Z"/>

      <!-- Inner panel -->
      <path d="M22 22 H42 L46 28 V36 L42 42 H22 L18 36 V28 Z"/>

      <!-- Mounting holes -->
      <circle cx="18" cy="24" r="2"/>
      <circle cx="46" cy="24" r="2"/>
      <circle cx="18" cy="40" r="2"/>
      <circle cx="46" cy="40" r="2"/>

      <!-- Vent slots -->
      <line x1="26" y1="30" x2="38" y2="30"/>
      <line x1="26" y1="34" x2="38" y2="34"/>
    </svg>
  `,
  gfed: `
    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 12c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>
  `,
  logs: `
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 64 64"
      aria-label="Data Disc">

      <defs>
        <!-- Outer shell gradient -->
        <linearGradient id="discOuterGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#3c4b6e"/>
          <stop offset="100%" stop-color="#121a2b"/>
        </linearGradient>

        <!-- Inner ring glow -->
        <radialGradient id="discCoreGrad" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#ffffff"/>
          <stop offset="40%" stop-color="#49f2ff"/>
          <stop offset="100%" stop-color="#00a8c6"/>
        </radialGradient>

        <!-- Soft glow -->
        <filter id="discGlow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="2.5" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Outer disc -->
      <circle cx="32" cy="32" r="24"
              fill="url(#discOuterGrad)"
              stroke="#0b1220"
              stroke-width="2"/>

      <!-- Segmented ring -->
      <path d="M32 14 A18 18 0 0 1 47 23"
            stroke="#7ee8ff"
            stroke-width="3"
            stroke-linecap="round"/>
      <path d="M50 32 A18 18 0 0 1 41 47"
            stroke="#7ee8ff"
            stroke-width="3"
            stroke-linecap="round"/>
      <path d="M32 50 A18 18 0 0 1 17 41"
            stroke="#7ee8ff"
            stroke-width="3"
            stroke-linecap="round"/>
      <path d="M14 32 A18 18 0 0 1 23 17"
            stroke="#7ee8ff"
            stroke-width="3"
            stroke-linecap="round"/>

      <!-- Inner ring -->
      <circle cx="32" cy="32" r="11"
              fill="#0a1023"
              stroke="#1f2a40"
              stroke-width="2"/>

      <!-- Center core -->
      <circle cx="32" cy="32" r="5"
              fill="url(#discCoreGrad)"
              filter="url(#discGlow)"/>

      <!-- Data lines -->
      <path d="M28 24 H36"
            stroke="#49f2ff"
            stroke-width="2"
            stroke-linecap="round"/>
      <path d="M28 40 H36"
            stroke="#49f2ff"
            stroke-width="2"
            stroke-linecap="round"/>

    </svg>
  `,
  bosses: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128" role="img" aria-label="Boss icon">
      <defs>
        <style>
          :root{
            --stroke:#0b1220;
            --armor1:#3a1a5a;
            --armor2:#140a26;
            --glow:#ff3df2;
            --accent:#ffd166;
          }
          .s{stroke:var(--stroke);stroke-width:4;stroke-linecap:round;stroke-linejoin:round}
        </style>

        <linearGradient id="bossBody" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="var(--armor1)"/>
          <stop offset="1" stop-color="var(--armor2)"/>
        </linearGradient>

        <radialGradient id="bossCore" cx="50%" cy="45%" r="60%">
          <stop offset="0" stop-color="#ffffff" stop-opacity="0.95"/>
          <stop offset="0.35" stop-color="var(--glow)" stop-opacity="0.95"/>
          <stop offset="1" stop-color="var(--glow)" stop-opacity="0"/>
        </radialGradient>

        <filter id="bossGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="2.8" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Outer “boss” shell -->
      <path class="s" fill="url(#bossBody)"
            d="M64 12
              C46 12 34 22 30 36
              C22 40 16 48 16 58
              C16 76 30 92 44 102
              C52 116 76 116 84 102
              C98 92 112 76 112 58
              C112 48 106 40 98 36
              C94 22 82 12 64 12 Z"/>

      <!-- Side horns / spikes -->
      <path class="s" fill="var(--armor2)" d="M30 44 L14 36 L18 54 Z"/>
      <path class="s" fill="var(--armor2)" d="M98 44 L114 36 L110 54 Z"/>

      <!-- Inner faceplate -->
      <path class="s" fill="#0a1023"
            d="M64 30
              C50 30 40 40 40 54
              C40 72 52 86 64 94
              C76 86 88 72 88 54
              C88 40 78 30 64 30 Z"/>

      <!-- Crown chevron -->
      <path class="s" fill="none" opacity="0.8"
            d="M46 38 L64 26 L82 38"/>

      <!-- Core glow -->
      <circle cx="64" cy="56" r="20" fill="url(#bossCore)" filter="url(#bossGlow)"/>

      <!-- Core -->
      <circle class="s" cx="64" cy="56" r="10" fill="var(--glow)"/>
      <circle cx="60.5" cy="52.5" r="2.8" fill="#ffffff" opacity="0.9"/>

      <!-- “Boss” marks -->
      <path class="s" fill="none" opacity="0.7" d="M50 76 L64 84 L78 76"/>
      <path class="s" fill="none" opacity="0.45" d="M54 90 L64 96 L74 90"/>

      <!-- Gold threat node -->
      <circle class="s" cx="64" cy="110" r="6.5" fill="var(--accent)"/>
    </svg>
  `,
  bombs: `
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 64 64"
      width="28" height="28"
      fill="none"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-label="Power Bomb Expansion">

      <!-- Outer blast ring -->
      <circle
        cx="32" cy="32" r="20"
        stroke="#D07CFF"
        stroke-width="3"
        opacity="0.9"
      />

      <!-- Bomb body -->
      <circle
        cx="32" cy="34" r="10"
        fill="#2A1538"
        stroke="#FF9AEF"
        stroke-width="2.5"
      />

      <!-- Fuse -->
      <path
        d="M32 24 V18"
        stroke="#FFFFFF"
        stroke-width="2.5"
      />
      <path
        d="M28 18 H36"
        stroke="#FFFFFF"
        stroke-width="2.5"
      />

      <!-- Energy sparks -->
      <g stroke="#FF6AD5" stroke-width="2.5">
        <path d="M32 8  V14"/>
        <path d="M32 50 V56"/>
        <path d="M8  32 H14"/>
        <path d="M50 32 H56"/>

        <path d="M14 14 L18 18"/>
        <path d="M46 46 L50 50"/>
        <path d="M14 50 L18 46"/>
        <path d="M46 18 L50 14"/>
      </g>
    </svg>
  `,
  research: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"
      width="28" height="28" fill="none" stroke="currentColor"
      stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
      aria-label="Research Sample">

      <!-- Flask outline -->
      <path d="M26 6 H38"/>
      <path d="M30 6 V18 L18 40 A8 8 0 0 0 26 52 H38 A8 8 0 0 0 46 40 L34 18 V6"/>

      <!-- Fluid level -->
      <line x1="24" y1="36" x2="40" y2="36"/>

      <!-- Bubbles -->
      <circle cx="30" cy="30" r="1.5"/>
      <circle cx="34" cy="26" r="1.5"/>
    </svg>
  `,
  save: `
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 64 64"
      aria-label="Save Station Tube">

      <defs>
        <!-- Yellow tube body -->
        <linearGradient id="tubeYellow" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#FFE866"/>
          <stop offset="50%" stop-color="#FFD600"/>
          <stop offset="100%" stop-color="#E6B800"/>
        </linearGradient>

        <!-- Cyan core glow -->
        <radialGradient id="tubeCore" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#E9FBFF"/>
          <stop offset="40%" stop-color="#49F2FF"/>
          <stop offset="100%" stop-color="#00A8C6"/>
        </radialGradient>

        <!-- Soft glow -->
        <filter id="tubeGlow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="2.5" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Bottom base -->
      <rect x="18" y="48" width="28" height="8" rx="3"
            fill="#1B2235"
            stroke="#0B1220"
            stroke-width="2"/>

      <!-- Tube body -->
      <rect x="20" y="10" width="24" height="40" rx="12"
            fill="url(#tubeYellow)"
            stroke="#0B1220"
            stroke-width="2"/>

      <!-- Glass inner panel -->
      <rect x="25" y="16" width="14" height="28" rx="7"
            fill="#0A1023"
            opacity="0.8"/>

      <!-- Vertical energy core -->
      <rect x="29" y="18" width="6" height="24" rx="3"
            fill="url(#tubeCore)"
            filter="url(#tubeGlow)"/>

      <!-- Top cap -->
      <rect x="22" y="6" width="20" height="8" rx="4"
            fill="#1B2235"
            stroke="#0B1220"
            stroke-width="2"/>

    </svg>
  `,
  keys: `
    <svg xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 128 128"
        role="img"
        aria-label="Teleport Key (colored)">
      <defs>
        <!-- Key metal -->
        <linearGradient id="tkMetal" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#F6FBFF"/>
          <stop offset="45%" stop-color="#BFD2E6"/>
          <stop offset="100%" stop-color="#7B90A8"/>
        </linearGradient>

        <!-- Key inner shine -->
        <linearGradient id="tkShine" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.85"/>
          <stop offset="55%" stop-color="#FFFFFF" stop-opacity="0"/>
        </linearGradient>

        <!-- Teleport energy -->
        <radialGradient id="tkEnergy" cx="50%" cy="45%" r="60%">
          <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.95"/>
          <stop offset="35%" stop-color="#7CFFFA" stop-opacity="0.95"/>
          <stop offset="70%" stop-color="#32C8FF" stop-opacity="0.85"/>
          <stop offset="100%" stop-color="#1B4DFF" stop-opacity="0"/>
        </radialGradient>

        <!-- Glow -->
        <filter id="tkGlow" x="-40%" y="-40%" width="180%" height="180%">
          <feGaussianBlur stdDeviation="3" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>

        <!-- Subtle shadow for depth -->
        <filter id="tkShadow" x="-40%" y="-40%" width="180%" height="180%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000000" flood-opacity="0.35"/>
        </filter>
      </defs>

      <!-- Teleport aura behind key -->
      <circle cx="48" cy="52" r="30" fill="url(#tkEnergy)" filter="url(#tkGlow)"/>

      <!-- Orbit ring -->
      <circle cx="48" cy="52" r="26" fill="none" stroke="#7CFFFA" stroke-width="4" opacity="0.55"/>
      <path d="M26 52 A22 22 0 0 1 48 30" fill="none" stroke="#FFFFFF" stroke-width="4" opacity="0.35" stroke-linecap="round"/>

      <!-- Key group -->
      <g filter="url(#tkShadow)">
        <!-- Key head -->
        <circle cx="48" cy="52" r="16" fill="url(#tkMetal)" stroke="#0B1220" stroke-width="4"/>
        <!-- Key hole -->
        <path d="M48 46
                a6 6 0 1 0 0 12
                a6 6 0 1 0 0-12
                M48 58
                v10"
              fill="none" stroke="#0B1220" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        <!-- Inner energy core inside head -->
        <circle cx="48" cy="52" r="7" fill="#32C8FF" opacity="0.9" filter="url(#tkGlow)"/>
        <!-- Head shine -->
        <path d="M37 43
                C44 38, 56 38, 61 46
                C54 44, 45 44, 37 48 Z"
              fill="url(#tkShine)" opacity="0.9"/>
        <!-- Key shaft -->
        <rect x="62" y="48" width="46" height="10" rx="5"
              fill="url(#tkMetal)" stroke="#0B1220" stroke-width="4"/>
        <!-- Shaft highlight -->
        <path d="M66 50 H104" stroke="#FFFFFF" stroke-opacity="0.35" stroke-width="3" stroke-linecap="round"/>

        <!-- Teeth -->
        <path d="M92 58 V70" stroke="#0B1220" stroke-width="6" stroke-linecap="round"/>
        <path d="M104 58 V78" stroke="#0B1220" stroke-width="6" stroke-linecap="round"/>

        <!-- Teeth fill (metal) -->
        <path d="M92 58 V68" stroke="#9FB3C8" stroke-width="4" stroke-linecap="round"/>
        <path d="M104 58 V76" stroke="#9FB3C8" stroke-width="4" stroke-linecap="round"/>
      </g>

      <!-- Teleport "spark" ticks -->
      <g stroke="#7CFFFA" stroke-width="4" stroke-linecap="round" opacity="0.85">
        <path d="M48 16 V24"/>
        <path d="M48 80 V88"/>
        <path d="M16 52 H24"/>
        <path d="M72 52 H80"/>
      </g>

      <!-- Small arc sparks -->
      <g fill="none" stroke="#FFFFFF" stroke-width="3" stroke-linecap="round" opacity="0.45">
        <path d="M30 34 C34 30 38 28 44 26"/>
        <path d="M66 70 C62 74 58 76 52 78"/>
      </g>
    </svg>
  `,
};

const SVG_SIZES = {
  crystals: 100,
  missiles: 100,
  shots: 100,
  boosts: 100,
  bombs: 100,
  energy: 100,
  gfed: 28,
  maps: 100,
  keys: 100,
  terminals: 100,
  psychic: 100,
  mech: 100,
  biology: 100,
  bosses: 100,
  machines: 100,
  logs: 100,
  save: 100,
  research: 100
};

function createSvgMarker(category, isFound = false, iconKey = null, isLocked = false) {
  const size = SVG_SIZES[category] ?? 18;
  const catClass = String(category).trim().toLowerCase();
  const svg = SVG_ICONS[iconKey] || SVG_ICONS[category];

  const lockClass = (window.GG_EDIT_MODE && isLocked) ? "marker-locked" : "";

  return L.divIcon({
    className: '',
    iconSize: [34, 44],
    iconAnchor: [19, 44],
    popupAnchor: [1, -41],
    html: `
      <div class="marker marker-${catClass} ${isFound ? 'marker-found' : ''} ${lockClass}">
        <div style="
          width:${size}px;
          height:${size}px;
          display:flex;
          align-items:center;
          justify-content:center;
          transform: rotate(45deg);
        ">
          ${svg}
        </div>
      </div>
    `
  });
}

/* ---------- MAP ---------- */
var map = L.map('map', { 
  zoomControl: false,
  attributionControl: false
});

const tileLayers = {
  viewros: {
    layer: L.tileLayer('tiles/viewros/{z}/{x}/{y}.png', {
      maxZoom: 5,
      minZoom: 2,
      noWrap: true,
      bounds: [[-76,-180],[85,110.8]]
    }),
    defaultZoom: 2,
    defaultCenter: [25.8, -36.56]
  },

  dungeons: {
    layer: L.tileLayer('tiles/dungeons/{z}/{x}/{y}.png', {
      maxZoom: 9,
      maxNativeZoom: 9,
      minZoom: 3,
      noWrap: true,
      bounds: [[37.02,-180],[85,23.91]]
    }),
    defaultZoom: 3,
    defaultCenter: [73.78, -100.55]
  }
};

let currentLayer = "viewros";
tileLayers[currentLayer].layer.addTo(map);
map.setView(
  tileLayers[currentLayer].defaultCenter,
  tileLayers[currentLayer].defaultZoom
);

const markers = {};
const foundMarkers = {};
let hideFound = false;

let totalCount = 0;

/* ---------- PROGRESS COUNTER UPDATER ---------- */
function updateProgressDisplay() {
  const foundCount = Object.keys(foundMarkers).length;
  const percent = totalCount > 0 ? Math.round((foundCount / totalCount) * 100) : 0;

  document.getElementById("progressDetails").innerText =
    `${foundCount} / ${totalCount} (${percent}%)`;

  // Update progress bar width
  document.getElementById("progressBarInner").style.width = percent + "%";

  // Handle 100% star
  const star = document.getElementById("progressStar");

  if (percent === 100) {
    star.style.display = "inline-block"; // show star
    star.style.opacity = "1";
    star.style.transform = "scale(1)";
  } else {
    star.style.display = "none"; // remove star from layout
  }
}

/* ---------- HELPER FUNCTIONS ---------- */

function stopAllPopupVideos() {
  document.querySelectorAll(".leaflet-popup video").forEach(video => {
    video.pause();
    video.removeAttribute("src"); // optional: frees memory
    video.load();
  });
}

function jumpToMarker(targetId, zoomOverride = null) {
  const allMarkers = { ...markers, ...foundMarkers };
  const target = allMarkers[targetId];
  if (!target) return;

  forcedVisibleMarkers.add(targetId);

  const targetZoom = zoomOverride ?? map.getZoom();

  const showTarget = () => {
    target.addTo(map); // 🔑 MUST be on map
    map.setView(target.getLatLng(), targetZoom, { animate: true });
    target.openPopup();

    target.once("popupclose", () => {
      forcedVisibleMarkers.delete(targetId);
      updateMarkersByCategory();
    });
  };

  // Switch layer if needed
  if (target.mapLayer !== currentLayer) {
    const newLayer = tileLayers[target.mapLayer].layer;

    document.getElementById("layerSelect").value = target.mapLayer;
    document.getElementById("layerSelect").dispatchEvent(new Event("change"));

    // Wait for tiles to load before opening popup
    newLayer.once("load", () => {
      requestAnimationFrame(showTarget);
    });
  } else {
    requestAnimationFrame(showTarget);
  }

  map.panTo(target.getLatLng());
}


document.getElementById("layerSelect").addEventListener("change", e => {
  stopAllPopupVideos();

  const newLayerKey = e.target.value;
  if (newLayerKey === currentLayer) return;

  const oldLayer = tileLayers[currentLayer].layer;
  const newLayer = tileLayers[newLayerKey].layer;
  const { defaultCenter, defaultZoom } = tileLayers[newLayerKey];

  // Add new layer FIRST (keeps old tiles visible)
  newLayer.addTo(map);

  // Lock view instantly (no animation = no stutter)
  map.setView(defaultCenter, defaultZoom, {
    animate: false,
    reset: true
  });

  // Wait until new tiles are ready
  newLayer.once("load", () => {
    map.removeLayer(oldLayer);
  });

  currentLayer = newLayerKey;

  updateMarkersByCategory();
});

// Make sidebar subcategories collapsible
document.querySelectorAll('.subcategory').forEach(section => {
  const header = section.querySelector('h3');
  const content = section.querySelector('.subcategory-content');

  // Start expanded
  section.classList.remove("collapsed");

  header.addEventListener('click', () => {
    section.classList.toggle("collapsed");
  });
});

const searchInput = document.getElementById('markerSearch');

/* ---------- HIDE/SHOW FOUND ---------- */
document.getElementById("foundToggle").onclick = () => {
  hideFound = !hideFound;

  if (hideFound) {
    Object.values(foundMarkers).forEach(m => map.removeLayer(m));
    document.getElementById("foundToggle").innerText = "Show Found Items";
  } else {
    Object.values(foundMarkers).forEach(m => m.addTo(map));
    document.getElementById("foundToggle").innerText = "Hide Found Items";
  }
};

/* ---------- SHOW ALL / HIDE ALL CATEGORY TOGGLES ---------- */
document.getElementById("showAllBtn").onclick = () => {
  document.querySelectorAll('.category').forEach(box => box.checked = true);
  updateMarkersByCategory();
};

document.getElementById("hideAllBtn").onclick = () => {
  document.querySelectorAll('.category').forEach(box => box.checked = false);
  updateMarkersByCategory();
};

/* ---------- CATEGORY FILTERING ---------- */
function updateMarkersByCategory() {
  const active = [...document.querySelectorAll('.category:checked')].map(x => x.value);

  const isFoundMarker = (m) => !!foundMarkers[m.__id];
  const isForced = (m) => forcedVisibleMarkers.has(m.__id);

  [...Object.values(markers), ...Object.values(foundMarkers)].forEach(m => {
    const allowedByCategory = active.includes(m.category) || isForced(m);
    const allowedByLayer = m.mapLayer === currentLayer;

    // ✅ if forced, show even when hideFound is true
    const allowedByFoundToggle = !hideFound || !isFoundMarker(m) || isForced(m);

    if (allowedByCategory && allowedByLayer && allowedByFoundToggle) {
      m.addTo(map);
    } else {
      map.removeLayer(m);
    }
  });
}

document.querySelectorAll('.category').forEach(b => {
  b.addEventListener('change', updateMarkersByCategory);
});

function updateMarkersBySearch() {
  const query = searchInput.value.toLowerCase();
  const activeCategories = [...document.querySelectorAll('.category:checked')].map(x => x.value);

  const isFoundMarker = (m) => !!foundMarkers[m.__id];
  const isForced = (m) => forcedVisibleMarkers.has(m.__id);

  if (!query) {
    updateMarkersByCategory();
    return;
  }

  [...Object.values(markers), ...Object.values(foundMarkers)].forEach(marker => {
    const matchesCategory = activeCategories.includes(marker.category) || isForced(marker);

    const titleMatch = (marker.options.title || "").toLowerCase().includes(query);
    const descMatch = (marker.description || "").toLowerCase().includes(query);
    const matchesSearch = titleMatch || descMatch;

    const matchesLayer = marker.mapLayer === currentLayer;

    const allowedByFoundToggle = !hideFound || !isFoundMarker(marker) || isForced(marker);

    if (matchesCategory && matchesSearch && matchesLayer && allowedByFoundToggle) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
    }
  });
}

// Run live search whenever input changes
searchInput.addEventListener('input', updateMarkersBySearch);

// Make category filtering also respect search
function updateMarkersByCategoryAndSearch() {
  updateMarkersBySearch();
}

// Update category event listener
document.querySelectorAll('.category').forEach(b => {
  b.addEventListener('change', updateMarkersByCategoryAndSearch);
});

map.on("click", (e) => {
  if (window.GG_EDIT_MODE) {
    if (window.GG_COPIED_MARKER) {
      window.pasteCopiedMarkerAt(e.latlng);
    } else if (typeof window.GG_ADD_MARKER_AT === "function") {
      window.GG_ADD_MARKER_AT(e.latlng);
    } else {
      // Queue the click so it works once markers/module are ready
      window.GG_PENDING_ADD_LATLNGS.push(e.latlng);
      console.warn("Edit mode active, marker tools not ready yet — queued click.");
    }
    return;
  }
});

</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

  // Firebase config
  const firebaseConfig = {
      apiKey: "AIzaSyBGI-tSZjsy7wvNSu3D_lFZR96TQND-uJU",
      authDomain: "gamegazetteer-bfed2.firebaseapp.com",
      projectId: "gamegazetteer-bfed2",
      storageBucket: "gamegazetteer-bfed2.appspot.com",
      messagingSenderId: "659845857638",
      appId: "1:659845857638:web:7ad66baffa924961a948a7",
      measurementId: "G-Q8QP2RD1BL"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  // const analytics = getAnalytics(app);
  const auth = getAuth();
  const db = getFirestore();

  let isLoggedIn = false;

  let didLoadMarkers = false;

  function applyLockState(marker, locked) {
    marker.isLocked = !!locked;

    // IMPORTANT: options.draggable must reflect lock state
    marker.options.draggable = window.GG_EDIT_MODE && !marker.isLocked;

    const drag = ensureDragging(marker);
    if (drag) {
      if (marker.options.draggable) drag.enable();
      else drag.disable();
    }
  }

  function ensureDragging(marker) {
    // If Leaflet already attached dragging, great
    if (marker.dragging) return marker.dragging;

    // Force-create the drag handler if Leaflet didn't
    if (window.L?.Handler?.MarkerDrag) {
      marker.dragging = new L.Handler.MarkerDrag(marker);
      return marker.dragging;
    }

    return null;
  }

  function attachClick(marker) {
    marker.off("click");

    marker.on("click", (e) => {
      // ✅ Stop the actual DOM event so it doesn't reach the map
      if (e?.originalEvent) {
        L.DomEvent.stop(e.originalEvent); // prevents + stops propagation
      }

      // Link mode behavior (unchanged)
      if (window.GG_EDIT_MODE && window.GG_LINKING_FROM) {
        if (window.GG_LINKING_FROM.__id === marker.__id) {
          toast("Can't link a marker to itself");
          return;
        }
        addLink(window.GG_LINKING_FROM, marker);
        window.GG_LINKING_FROM = null;
        toast("Link added");
        return;
      }

      marker.openPopup();
    });
  }

  function attachRightClick(marker) {
    marker.off("contextmenu");

    marker.on("contextmenu", (e) => {
      if (e?.originalEvent) {
        // Don’t use L.DomEvent.stop() here — it can be too aggressive.
        L.DomEvent.preventDefault(e.originalEvent);   // blocks browser menu
        L.DomEvent.stopPropagation(e.originalEvent);  // keeps map click from firing
      }

      // EDIT MODE: toggle locked
      if (window.GG_EDIT_MODE) {
        const nowLocked = !marker.isLocked;

        if (marker.__dataRef) {
          if (nowLocked) marker.__dataRef.locked = true;
          else delete marker.__dataRef.locked;
        }

        applyLockState(marker, nowLocked);

        marker.setIcon(
          createSvgMarker(marker.category, marker.isFound, marker.iconKey, nowLocked)
        );

        createMarkerPopup(marker, marker.__id);

        // ✅ IMPORTANT: icon swap can break the click target; rebind click handler
        attachClick(marker);

        return;
      }

      // NORMAL MODE: toggle found
      toggleFound(marker.__id, { checked: !marker.isFound, openPopup: false });
    });
  }

  async function loadMarkers(foundIds) {
    if (didLoadMarkers) return;
    didLoadMarkers = true;

    fetch('metroid-prime-4-markers.json')
      .then(res => res.json())
      .then(data => {
        window.GG_MARKER_DATA = data;
        totalCount = data.length;

        data.forEach(point => {
          const id = `${point.layer}:${point.id}`;
          const isFound = foundIds.includes(id);

          const marker = L.marker(point.coords, {
            icon: createSvgMarker(point.category, isFound, point.icon, !!point.locked),
            title: point.name,
            draggable: window.GG_EDIT_MODE && !point.locked
          });

          marker.__dataRef = point;
          applyLockState(marker, !!point.locked);

          if (window.GG_EDIT_MODE) {
            // Ensure dragging exists even if Leaflet didn't attach it for some reason

            const drag = ensureDragging(marker);
            if (drag) {
              if (marker.isLocked) drag.disable();
              else drag.enable();
            }

            marker.on("dragend", () => {
              const pos = marker.getLatLng();
              point.coords = [pos.lat, pos.lng];
            });
          }

          marker.category = point.category;
          marker.description = point.description;
          marker.links = point.links || [];
          marker.isFound = isFound;
          marker.mapLayer = point.layer || currentLayer;
          marker.__id = id;
          marker.iconKey = point.icon;
          marker.mp4 = point.mp4;
          marker.image = point.image;

          if (isFound) foundMarkers[id] = marker;
          else markers[id] = marker;

          if (marker.mapLayer === currentLayer) marker.addTo(map);

          createMarkerPopup(marker, id);
          attachClick(marker);
          attachRightClick(marker);

        });

        updateProgressDisplay();
        updateMarkersByCategory();
        // Flush any queued map clicks from edit mode
        if (window.GG_PENDING_ADD_LATLNGS?.length && typeof window.GG_ADD_MARKER_AT === "function") {
          const queued = [...window.GG_PENDING_ADD_LATLNGS];
          window.GG_PENDING_ADD_LATLNGS.length = 0;
          queued.forEach(ll => window.GG_ADD_MARKER_AT(ll));
        }
      })
      .catch(err => {
        console.error("Marker JSON load failed:", err);
      });
  }

  // Check Logged in
  onAuthStateChanged(auth, async user => {
    let foundIds = [];

    try {
      if (user) {
        isLoggedIn = true;
        foundIds = await loadFoundMarkersFromFirebase(user);
      } else {
        isLoggedIn = false;
        foundIds = Object.keys(localStorage)
          .filter(k => k.startsWith("found_") && localStorage.getItem(k) === "true")
          .map(k => k.replace("found_", ""));
      }
    } catch (e) {
      console.error("Auth/progress load failed, falling back:", e);
      isLoggedIn = false;
      foundIds = Object.keys(localStorage)
        .filter(k => k.startsWith("found_") && localStorage.getItem(k) === "true")
        .map(k => k.replace("found_", ""));
    }

    await loadMarkers(foundIds);
  });

  // LOAD found markers from Firebase
  async function loadFoundMarkersFromFirebase(user) {
    try {
        const ref = doc(db, "users", user.uid, "progress", "foundMarkers");
        const snap = await getDoc(ref);

        if (!snap.exists()) return [];

        const found = snap.data().found;

        return Array.isArray(found) ? found : [];
    } 
    catch (err) {
        console.error("FIREBASE READ ERROR:", err);
        return [];
    }
  }


  // SAVE found markers TO Firebase
  async function saveFoundMarkersToFirebase(user, foundIdsArray) {
      const ref = doc(db, "users", user.uid, "progress", "foundMarkers");
      await setDoc(ref, { found: foundIdsArray });
  }

  /* ---------- SIDEBAR TOGGLE ---------- */
  document.getElementById("toggleSidebar").onclick = () => {
    const side = document.getElementById("controls");
    side.style.display = side.style.display === "none" ? "block" : "none";
  };

  async function toggleFound(id, checkboxOrOpts) {
    const marker = markers[id] || foundMarkers[id];
    if (!marker) return;

    // Support BOTH call styles:
    // - toggleFound(id, e.target)  (from popup checkbox)
    // - toggleFound(id, { checked: true/false, openPopup: false }) (from right-click)
    const isOpts = checkboxOrOpts && typeof checkboxOrOpts === "object" && "checked" in checkboxOrOpts;
    const isNowFound = isOpts ? !!checkboxOrOpts.checked : !!checkboxOrOpts?.checked;
    const openPopup = (checkboxOrOpts && typeof checkboxOrOpts === "object" && "openPopup" in checkboxOrOpts)
      ? !!checkboxOrOpts.openPopup
      : true;

    marker.isFound = isNowFound;

    // Move between buckets
    marker.setIcon(createSvgMarker(marker.category, marker.isFound, marker.iconKey, !!marker.isLocked));

    if (isNowFound) {
      delete markers[id];
      foundMarkers[id] = marker;
    } else {
      delete foundMarkers[id];
      markers[id] = marker;
    }

    // Persist progress
    if (isLoggedIn && auth.currentUser) {
      let foundIds = Object.keys(foundMarkers);
      if (isNowFound && !foundIds.includes(String(id))) foundIds.push(String(id));
      if (!isNowFound) foundIds = foundIds.filter(x => x !== String(id));

      await saveFoundMarkersToFirebase(auth.currentUser, foundIds);
    } else {
      if (isNowFound) localStorage.setItem(`found_${id}`, "true");
      else localStorage.removeItem(`found_${id}`);
    }

    updateMarkersByCategory();
    updateProgressDisplay();

    createMarkerPopup(marker, id);

    attachClick(marker);
    attachRightClick(marker);

    // ✅ Only open popup when we want to
    if (openPopup) marker.openPopup();
    else marker.closePopup();
  }

  // ============================
  // EDIT MODE: Copy/Paste Marker
  // ============================
  window.GG_COPIED_MARKER = null;        // holds a JSON-ish point template
  window.GG_SELECTED_MARKER = null;      // last popup-opened marker

  function makeUniqueId(baseId, layer) {
    const base = String(baseId ?? "").trim();
    if (!base) return null;

    const exists = (fullId) => (markers[fullId] || foundMarkers[fullId]);
    const full = (id) => `${layer}:${id}`;

    // If base doesn't exist yet, use it
    if (!exists(full(base))) return base;

    // Otherwise try base2, base3, ...
    let n = 2;
    while (n < 10000) {
      const candidate = `${base}${n}`;
      if (!exists(full(candidate))) return candidate;
      n++;
    }
    return null;
  }

  function removePointFromMarkerData(fullId) {
    // fullId looks like "layer:id"
    const [layer, id] = String(fullId).split(":");
    const idx = window.GG_MARKER_DATA.findIndex(p => String(p.layer) === String(layer) && String(p.id) === String(id));
    if (idx >= 0) window.GG_MARKER_DATA.splice(idx, 1);
    totalCount = window.GG_MARKER_DATA.length;
  }

  function deleteMarkerEverywhere(fullId) {
    const m = markers[fullId] || foundMarkers[fullId];
    if (!m) return;

    // Remove from map
    try { map.removeLayer(m); } catch {}

    // Remove from buckets
    delete markers[fullId];
    delete foundMarkers[fullId];

    // Remove from raw JSON
    removePointFromMarkerData(fullId);

    // Remove found-state persistence for this id (best-effort)
    try {
      localStorage.removeItem(`found_${fullId}`);
    } catch {}

    // Update UI
    updateMarkersByCategory();
    updateProgressDisplay();
  }

  function clonePointTemplateFromMarker(marker) {
    const p = marker?.__dataRef;
    if (!p) return null;

    // Clone only the marker JSON fields you care about
    return {
      id: p.id,
      layer: p.layer ?? marker.mapLayer ?? currentLayer,
      coords: Array.isArray(p.coords) ? [...p.coords] : [marker.getLatLng().lat, marker.getLatLng().lng],
      category: p.category ?? marker.category ?? "crystals",
      icon: p.icon ?? marker.iconKey ?? "crystals",
      name: p.name ?? marker.options.title ?? "New Marker",
      description: p.description ?? "",
      image: p.image,
      mp4: p.mp4,
      locked: !!p.locked,
      links: Array.isArray(p.links) ? JSON.parse(JSON.stringify(p.links)) : []
    };
  }

  // Create a Leaflet marker + hook it up exactly like your loader does
  function createMarkerFromPoint(point, { openPopup = true } = {}) {
    const fullId = `${point.layer}:${point.id}`;

    const marker = L.marker(point.coords, {

      icon: createSvgMarker(point.category, false, point.icon, !!point.locked),
      title: point.name,
      draggable: window.GG_EDIT_MODE && !point.locked
    });

    marker.__dataRef = point;
    applyLockState(marker, !!point.locked);
    if (window.GG_EDIT_MODE) {

      const drag = ensureDragging(marker);
      if (drag) {
        if (marker.isLocked) drag.disable();
        else drag.enable();
      }
    }

    marker.on("dragend", () => {
      const pos = marker.getLatLng();
      point.coords = [pos.lat, pos.lng];
    });

    marker.category = point.category;
    marker.description = point.description;
    marker.links = point.links || [];
    marker.isFound = false;
    marker.mapLayer = point.layer || currentLayer;
    marker.__id = fullId;
    marker.iconKey = point.icon;
    marker.mp4 = point.mp4;
    marker.image = point.image;

    markers[fullId] = marker;

    if (marker.mapLayer === currentLayer) marker.addTo(map);

    createMarkerPopup(marker, fullId);
    attachClick(marker);
    attachRightClick(marker);
    updateMarkersByCategory();
    updateProgressDisplay();

    if (openPopup) marker.openPopup();

    return marker;
  }

  function getNextNumericId(prefix, layer, excludeId = null) {
    const pfx = String(prefix || "").trim();
    const lyr = String(layer || "").trim();
    if (!pfx) return null;

    let maxN = 0;

    for (const pt of (window.GG_MARKER_DATA || [])) {
      if (String(pt.layer || "") !== lyr) continue;

      const idStr = String(pt.id || "");
      if (excludeId && idStr === excludeId) continue;

      if (!idStr.startsWith(pfx)) continue;

      const suffix = idStr.slice(pfx.length);
      if (!suffix) continue;
      if (!/^\d+$/.test(suffix)) continue;

      const n = parseInt(suffix, 10);
      if (Number.isFinite(n) && n > maxN) maxN = n;
    }

    // Start at 1 if none exist
    let candidate = `${pfx}${maxN + 1}`;

    // Extra safety: avoid collisions with currently-loaded markers
    const full = (id) => `${lyr}:${id}`;
    while (markers[full(candidate)] || foundMarkers[full(candidate)]) {
      // if somehow taken, keep incrementing
      const m = candidate.match(/^(.+?)(\d+)$/);
      const base = m ? m[1] : pfx;
      const num = m ? parseInt(m[2], 10) + 1 : (maxN + 2);
      candidate = `${base}${num}`;
    }

    return candidate;
  }

  function getPrefixForCategory(category) {
    const c = String(category || "").toLowerCase();

    const prefixMap = {
      crystals: "crystal",
      missiles: "m",
      shots: "shot",
      bombs: "bomb",
      boosts: "boost",
      energy: "e",
      maps: "map",
      terminals: "t",
      psychic: "psy",
      mech: "mech",
      biology: "bio",
      machines: "mac",
      gfed: "npc",
      research: "r",
      bosses: "boss",
      lore: "lore",
      logs: "log",
      save: "save",
      keys: "key"
    };

    return prefixMap[c] || c.slice(0, 3) || "m";
  }

  window.GG_ADD_MARKER_AT = function(latlng) {
    if (!window.GG_EDIT_MODE) return;

    if (!didLoadMarkers || !Array.isArray(window.GG_MARKER_DATA)) {
      window.GG_PENDING_ADD_LATLNGS = window.GG_PENDING_ADD_LATLNGS || [];
      window.GG_PENDING_ADD_LATLNGS.push(latlng);
      console.warn("Markers not loaded yet — queued add.");
      return;
    }

    const layer = currentLayer;

    // Your current "default new marker" settings:
    const defaultCategory = "crystals";
    const defaultIcon = "crystals";

    // Prefix based on category (biology => bio, missiles => mis, etc.)
    const prefix = getPrefixForCategory(defaultCategory);
    let newId = getNextNumericId(prefix, layer);

    // fallback if something weird happens
    if (!newId) {
      newId = makeUniqueId(prefix, layer) || makeUniqueId("m", layer);
    }

    if (!newId) {
      alert("Couldn't generate a unique ID.");
      return;
    }

    const point = {
      id: newId,
      layer,
      coords: [latlng.lat, latlng.lng],
      category: defaultCategory,
      icon: defaultIcon,
      name: `New Marker (${newId})`
    };

    window.GG_MARKER_DATA.push(point);
    totalCount = window.GG_MARKER_DATA.length;

    createMarkerFromPoint(point, { openPopup: false });

    // Optional: quick feedback
    toast(`Added: ${layer}:${newId}`);
  };

  window.pasteCopiedMarkerAt = function pasteCopiedMarkerAt(latlng) {
    if (!window.GG_EDIT_MODE) return;
    if (!window.GG_COPIED_MARKER) {
      alert("No copied marker yet. Open a marker popup and click Copy.");
      return;
    }

    const src = window.GG_COPIED_MARKER;
    const layer = currentLayer;

    // new id = oldId_copy (or oldId_copy2, oldId_copy3...)
    const baseWanted = `${String(src.id ?? "").trim()}_copy`;
    const newId = makeUniqueId(baseWanted, layer);
    if (!newId) {
      alert("Couldn't generate a unique ID.");
      return;
    }

    const point = {
      ...src,
      id: newId,
      layer,
      coords: [latlng.lat, latlng.lng]
    };

    if (!point.description) delete point.description;
    if (!point.image) delete point.image;
    if (!point.mp4) delete point.mp4;
    if (!point.links?.length) delete point.links;

    window.GG_MARKER_DATA.push(point);
    totalCount = window.GG_MARKER_DATA.length;

    createMarkerFromPoint(point, { openPopup: true });
  };

  // Editor pick-lists (must match your checkbox values for filtering)
  const GG_CATEGORY_OPTIONS = [
    { value: "crystals", label: "Crystals" },
    { value: "missiles",   label: "Missile Expansions" },
    { value: "shots",    label: "Shot Expansions" },
    { value: "bombs",    label: "Bomb Expansions" },
    { value: "boosts",     label: "Viola Boost Tanks" },
    { value: "energy",    label: "Energy Tanks" },
    { value: "maps",      label: "Map Stations" },
    { value: "terminals",  label: "Terminals" },
    { value: "psychic",  label: "Psychic Upgrades" },
    { value: "gfed",  label: "Galactic Fed" },
    { value: "maps",  label: "Map Stations" },
    { value: "mech",  label: "Mech Parts" },
    { value: "research",  label: "Research" },
    { value: "machines",  label: "Machines" },
    { value: "biology",  label: "Biology" },
    { value: "bosses",  label: "Boss" },
    { value: "logs",  label: "Data Logs" },
    { value: "save",  label: "Save Station" },
    { value: "keys",  label: "Keys" }
  ];

  // Icon options = keys from your SVG_ICONS object
  function getIconOptions() {
    try {
      return Object.keys(SVG_ICONS).map(k => ({ value: k, label: k }));
    } catch {
      return [];
    }
  }

  function normalizeMediaPath(input, defaultFolder) {
    const v = (input ?? "").trim();
    if (!v) return ""; // blank => remove
    // If user typed a URL or already provided a folder path, keep it
    if (v.startsWith("http://") || v.startsWith("https://") || v.startsWith("/") || v.includes("/")) return v;
    // Otherwise auto-prefix
    return `${defaultFolder.replace(/\/$/, "")}/${v}`;
  }

  // Apply edits to BOTH the Leaflet marker and the backing JSON object
  function applyEditsToMarker(marker, oldFullId, { id, name, category, iconKey, description, image, mp4, locked }) {
    if (!marker) return;

    const point = marker.__dataRef;
    if (!point) return;

    const layer = point.layer || marker.mapLayer || currentLayer;

    // ============================
    // ID CHANGE (safe re-key)
    // ============================
    let newFullId = oldFullId;

    if (typeof id === "string" && id.trim() && id.trim() !== point.id) {
      const cleanId = id.trim();

      if (cleanId.includes(":")) {
        alert("ID cannot contain ':'");
        return;
      }
      if (/\s/.test(cleanId)) {
        alert("ID cannot contain spaces");
        return;
      }

      const candidateFullId = `${layer}:${cleanId}`;

      if (markers[candidateFullId] || foundMarkers[candidateFullId]) {
        alert(`A marker with ID "${candidateFullId}" already exists.`);
        return;
      }

      // remove old key
      delete markers[oldFullId];
      delete foundMarkers[oldFullId];

      // update ids
      point.id = cleanId;
      marker.__id = candidateFullId;

      // re-add to correct bucket
      if (marker.isFound) foundMarkers[candidateFullId] = marker;
      else markers[candidateFullId] = marker;

      newFullId = candidateFullId;
    }

    // ============================
    // OTHER FIELDS
    // ============================
    if (typeof name === "string") {
      const n = name.trim() || "Untitled Marker";
      marker.options.title = n;
      point.name = n;
    }

    if (typeof category === "string") {
      marker.category = category;
      point.category = category;
    }

    if (typeof locked === "boolean") {
      marker.isLocked = locked;
      if (locked) point.locked = true;
      else delete point.locked; // keeps JSON clean if false

      applyLockState(marker, locked);
    }

    if (typeof iconKey === "string") {
      marker.iconKey = iconKey;
      point.icon = iconKey;
    }

    // Description (blank => remove)
    if (typeof description === "string") {
      const d = description.trim();
      marker.description = d;
      if (d) point.description = d;
      else delete point.description;
    }

    // Image (blank => remove, filename => images/<file>)
    if (typeof image === "string") {
      const imgPath = normalizeMediaPath(image, "images");
      marker.image = imgPath || null;
      if (imgPath) point.image = imgPath;
      else delete point.image;
    }

    // MP4/GIF (blank => remove, filename => gifs/<file>)
    if (typeof mp4 === "string") {
      const mp4Path = normalizeMediaPath(mp4, "gifs");
      marker.mp4 = mp4Path || null;
      if (mp4Path) point.mp4 = mp4Path;
      else delete point.mp4;
    }

    // Refresh the marker icon
    marker.setIcon(createSvgMarker(marker.category, marker.isFound, marker.iconKey, !!marker.isLocked));

    // Rebuild popup (so image/video sections appear/disappear)
    createMarkerPopup(marker, newFullId);
    attachClick(marker);
    attachRightClick(marker);
    updateMarkersByCategory();
  }

  function createMarkerPopup(marker, id) {
    function stopBtn(e){
      if (e) { e.preventDefault(); e.stopPropagation(); }
      if (window.L?.DomEvent) L.DomEvent.stop(e);
    }
    const isFound = marker.isFound;

    // Create container div
    const popupContainer = document.createElement("div");
    popupContainer.style.fontFamily = "'Segoe UI', sans-serif";
    popupContainer.style.minWidth = "220px";
    popupContainer.style.color = "#fff";
    popupContainer.style.padding = "10px";

    // Title
    const title = document.createElement("h3");
    title.style.margin = "0 0 6px 0";
    title.style.fontSize = "20px";
    title.style.color = "#9c7cff";
    title.innerText = marker.options.title;
    popupContainer.appendChild(title);

    // Description
    if (marker.description) {
      const desc = document.createElement("p");
      desc.style.margin = "0 0 10px 0";
      desc.style.fontSize = "14px";
      desc.style.lineHeight = "1.4";
      desc.style.color = "#fff";
      desc.innerHTML = marker.description
        .replace(/\n/g, "<br>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>");
      popupContainer.appendChild(desc);
    }

    // ============================
    // EDIT UI (only in ?edit=true)
    // ============================
    if (window.GG_EDIT_MODE) {
      const editWrap = document.createElement("div");
      editWrap.style.marginTop = "10px";
      editWrap.style.padding = "10px";
      editWrap.style.borderRadius = "8px";
      editWrap.style.background = "rgba(255,255,255,0.06)";
      editWrap.style.border = "1px solid rgba(255,255,255,0.10)";

      const editTitle = document.createElement("div");
      editTitle.innerText = "Edit Marker";
      editTitle.style.fontWeight = "700";
      editTitle.style.marginBottom = "8px";
      editTitle.style.fontSize = "14px";
      editTitle.style.color = "#fff";
      editWrap.appendChild(editTitle);

      // --- ID input + Update button row ---
      const idLabel = document.createElement("div");
      idLabel.innerText = "ID";
      idLabel.style.fontSize = "12px";
      idLabel.style.opacity = "0.85";
      idLabel.style.marginBottom = "4px";
      editWrap.appendChild(idLabel);

      const idRow = document.createElement("div");
      idRow.style.display = "flex";
      idRow.style.gap = "8px";
      idRow.style.marginBottom = "10px";

      const idInput = document.createElement("input");
      idInput.type = "text";
      idInput.value = marker.__dataRef?.id || "";
      idInput.placeholder = "e.g. bio17 (no spaces, no :)";
      idInput.style.flex = "1";
      idInput.style.boxSizing = "border-box";
      idInput.style.padding = "8px";
      idInput.style.borderRadius = "8px";
      idInput.style.border = "none";
      idInput.style.outline = "none";
      idInput.style.background = "rgba(0,0,0,0.25)";
      idInput.style.color = "#fff";

      const updateIdBtn = document.createElement("button");
      updateIdBtn.type = "button";
      updateIdBtn.innerText = "Update ID";
      updateIdBtn.style.whiteSpace = "nowrap";
      updateIdBtn.style.padding = "8px 10px";
      updateIdBtn.style.borderRadius = "10px";
      updateIdBtn.style.border = "none";
      updateIdBtn.style.cursor = "pointer";
      updateIdBtn.style.fontWeight = "800";
      updateIdBtn.style.background = "rgba(255,255,255,0.12)";
      updateIdBtn.style.color = "white";

      idRow.appendChild(idInput);
      idRow.appendChild(updateIdBtn);
      editWrap.appendChild(idRow);

      // --- Name input ---
      const nameLabel = document.createElement("div");
      nameLabel.innerText = "Name";
      nameLabel.style.fontSize = "12px";
      nameLabel.style.opacity = "0.85";
      nameLabel.style.marginBottom = "4px";
      editWrap.appendChild(nameLabel);

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = marker.options.title || "";
      nameInput.placeholder = "Marker name...";
      nameInput.style.width = "100%";
      nameInput.style.boxSizing = "border-box";
      nameInput.style.padding = "8px";
      nameInput.style.borderRadius = "8px";
      nameInput.style.border = "none";
      nameInput.style.outline = "none";
      nameInput.style.marginBottom = "10px";
      nameInput.style.background = "rgba(0,0,0,0.25)";
      nameInput.style.color = "#fff";
      editWrap.appendChild(nameInput);

      // --- Category select ---
      const catLabel = document.createElement("div");
      catLabel.innerText = "Category";
      catLabel.style.fontSize = "12px";
      catLabel.style.opacity = "0.85";
      catLabel.style.marginBottom = "4px";
      editWrap.appendChild(catLabel);

      const catSelect = document.createElement("select");
      catSelect.style.width = "100%";
      catSelect.style.boxSizing = "border-box";
      catSelect.style.padding = "8px";
      catSelect.style.borderRadius = "8px";
      catSelect.style.border = "none";
      catSelect.style.outline = "none";
      catSelect.style.marginBottom = "10px";
      catSelect.style.background = "rgba(0,0,0,0.25)";
      catSelect.style.color = "#fff";

      GG_CATEGORY_OPTIONS.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.innerText = opt.label;
        catSelect.appendChild(o);
      });

      catSelect.value = marker.category || "crystals";
      editWrap.appendChild(catSelect);

      // --- Update ID button logic (based on selected category) ---
      updateIdBtn.onclick = (e) => {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        if (window.L?.DomEvent) L.DomEvent.stop(e);

        const layer = marker.__dataRef?.layer || marker.mapLayer || currentLayer;
        const selectedCategory = catSelect.value;

        const prefix = getPrefixForCategory(selectedCategory);

        // exclude this marker’s current id so we don’t “block” ourselves
        const currentIdOnly = String(marker.__dataRef?.id || "");

        const nextId = getNextNumericId(prefix, layer, currentIdOnly);
        if (!nextId) return;

        idInput.value = nextId;

        // optional: update the name input too, if you like
        // nameInput.value = `New Marker (${nextId})`;

        toast(`ID set to: ${layer}:${nextId}`);
      };

      // --- Icon select ---
      const iconLabel = document.createElement("div");
      iconLabel.innerText = "Icon";
      iconLabel.style.fontSize = "12px";
      iconLabel.style.opacity = "0.85";
      iconLabel.style.marginBottom = "4px";
      editWrap.appendChild(iconLabel);

      const iconSelect = document.createElement("select");
      iconSelect.style.width = "100%";
      iconSelect.style.boxSizing = "border-box";
      iconSelect.style.padding = "8px";
      iconSelect.style.borderRadius = "8px";
      iconSelect.style.border = "none";
      iconSelect.style.outline = "none";
      iconSelect.style.marginBottom = "10px";
      iconSelect.style.background = "rgba(0,0,0,0.25)";
      iconSelect.style.color = "#fff";

      const iconOptions = getIconOptions();
      iconOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.innerText = opt.label;
        iconSelect.appendChild(o);
      });

      iconSelect.value = marker.iconKey || marker.category || "crystals";
      editWrap.appendChild(iconSelect);

      // --- Description textarea ---
      const descLabel = document.createElement("div");
      descLabel.innerText = "Description";
      descLabel.style.fontSize = "12px";
      descLabel.style.opacity = "0.85";
      descLabel.style.marginBottom = "4px";
      editWrap.appendChild(descLabel);

      const descInput = document.createElement("textarea");
      descInput.value = marker.__dataRef?.description || "";
      descInput.placeholder = "Optional. Supports your *italics* formatting.";
      descInput.rows = 4;
      descInput.style.width = "100%";
      descInput.style.boxSizing = "border-box";
      descInput.style.padding = "8px";
      descInput.style.borderRadius = "8px";
      descInput.style.border = "none";
      descInput.style.outline = "none";
      descInput.style.marginBottom = "10px";
      descInput.style.resize = "vertical";
      descInput.style.background = "rgba(0,0,0,0.25)";
      descInput.style.color = "#fff";
      editWrap.appendChild(descInput);

      // --- Image filename/path ---
      const imgLabel = document.createElement("div");
      imgLabel.innerText = "Image (filename or path)";
      imgLabel.style.fontSize = "12px";
      imgLabel.style.opacity = "0.85";
      imgLabel.style.marginBottom = "4px";
      editWrap.appendChild(imgLabel);

      const imgInput = document.createElement("input");
      imgInput.type = "text";
      imgInput.value = marker.__dataRef?.image || "";
      imgInput.placeholder = "e.g. c1.jpg (auto => images/c1.jpg) or images/c1.jpg or https://...";
      imgInput.style.width = "100%";
      imgInput.style.boxSizing = "border-box";
      imgInput.style.padding = "8px";
      imgInput.style.borderRadius = "8px";
      imgInput.style.border = "none";
      imgInput.style.outline = "none";
      imgInput.style.marginBottom = "10px";
      imgInput.style.background = "rgba(0,0,0,0.25)";
      imgInput.style.color = "#fff";
      editWrap.appendChild(imgInput);

      // --- GIF/MP4 filename/path ---
      const mp4Label = document.createElement("div");
      mp4Label.innerText = "GIF/MP4 (filename or path)";
      mp4Label.style.fontSize = "12px";
      mp4Label.style.opacity = "0.85";
      mp4Label.style.marginBottom = "4px";
      editWrap.appendChild(mp4Label);

      const mp4Input = document.createElement("input");
      mp4Input.type = "text";
      mp4Input.value = marker.__dataRef?.mp4 || "";
      mp4Input.placeholder = "e.g. clip1.mp4 (auto => gifs/clip1.mp4) or gifs/clip1.mp4 or https://...";
      mp4Input.style.width = "100%";
      mp4Input.style.boxSizing = "border-box";
      mp4Input.style.padding = "8px";
      mp4Input.style.borderRadius = "8px";
      mp4Input.style.border = "none";
      mp4Input.style.outline = "none";
      mp4Input.style.marginBottom = "10px";
      mp4Input.style.background = "rgba(0,0,0,0.25)";
      mp4Input.style.color = "#fff";
      editWrap.appendChild(mp4Input);

      // --- Lock toggle (disable dragging) ---
      const lockRow = document.createElement("label");
      lockRow.className = "popup-toggle";
      lockRow.style.marginTop = "6px";
      lockRow.innerText = "Lock (disable drag) ";

      const lockInput = document.createElement("input");
      lockInput.type = "checkbox";
      lockInput.checked = !!(marker.__dataRef?.locked);

      lockInput.addEventListener("change", () => {
        const locked = lockInput.checked;

        // Update JSON cleanly
        if (marker.__dataRef) {
          if (locked) marker.__dataRef.locked = true;
          else delete marker.__dataRef.locked;
        }

        // Apply lock state + dragging config
        applyLockState(marker, locked);

        // Refresh icon (red outline only in edit mode)
        marker.setIcon(createSvgMarker(marker.category, marker.isFound, marker.iconKey, locked));
      });

      lockRow.appendChild(lockInput);
      editWrap.appendChild(lockRow);

      // --- Copy + Paste row ---
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.marginBottom = "10px";

      const copyBtn = document.createElement("button");
      copyBtn.innerText = "Copy Marker";
      copyBtn.style.flex = "1";
      copyBtn.style.padding = "10px";
      copyBtn.style.borderRadius = "10px";
      copyBtn.style.border = "none";
      copyBtn.style.cursor = "pointer";
      copyBtn.style.fontWeight = "700";
      copyBtn.style.background = "rgba(255,255,255,0.12)";
      copyBtn.style.color = "white";

      copyBtn.onclick = () => {
        window.GG_COPIED_MARKER = clonePointTemplateFromMarker(marker);
        alert(`Copied "${marker.options.title}" (id: ${marker.__dataRef?.id})\nClick map to paste.`);
      };

      const pasteBtn = document.createElement("button");
      pasteBtn.innerText = "Paste Here";
      pasteBtn.style.flex = "1";
      pasteBtn.style.padding = "10px";
      pasteBtn.style.borderRadius = "10px";
      pasteBtn.style.border = "none";
      pasteBtn.style.cursor = "pointer";
      pasteBtn.style.fontWeight = "700";
      pasteBtn.style.background = "rgba(255,255,255,0.12)";
      pasteBtn.style.color = "white";

      pasteBtn.onclick = () => {
        // paste near the current marker (slight offset so it doesn't stack perfectly)
        const ll = marker.getLatLng();
        window.pasteCopiedMarkerAt({ lat: ll.lat + 0.2, lng: ll.lng + 0.2 });
      };
      row.appendChild(copyBtn);
      row.appendChild(pasteBtn);
      editWrap.appendChild(row);

      // --- Links editor ---
      const linksTitle = document.createElement("div");
      linksTitle.innerText = "Links";
      linksTitle.style.fontWeight = "800";
      linksTitle.style.margin = "12px 0 8px 0";
      linksTitle.style.fontSize = "13px";
      linksTitle.style.opacity = "0.95";
      editWrap.appendChild(linksTitle);

      const linksList = document.createElement("div");
      linksList.style.display = "flex";
      linksList.style.flexDirection = "column";
      linksList.style.gap = "6px";
      editWrap.appendChild(linksList);

      const currentLinks = marker.__dataRef?.links || [];
      if (currentLinks.length === 0) {
        const empty = document.createElement("div");
        empty.innerText = "No links yet.";
        empty.style.fontSize = "12px";
        empty.style.opacity = "0.8";
        linksList.appendChild(empty);
      } else {
        currentLinks.forEach(l => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.justifyContent = "space-between";
          row.style.gap = "8px";
          row.style.background = "rgba(0,0,0,0.22)";
          row.style.border = "1px solid rgba(255,255,255,0.10)";
          row.style.borderRadius = "10px";
          row.style.padding = "8px";

          const left = document.createElement("div");
          left.style.fontSize = "12px";
          left.style.lineHeight = "1.2";
          left.innerText = `${l.label || "Link"} → ${l.target || ""}`;
          row.appendChild(left);

          const del = document.createElement("button");
          del.type = "button";
          del.innerText = "Remove";
          del.style.padding = "6px 10px";
          del.style.borderRadius = "10px";
          del.style.border = "none";
          del.style.cursor = "pointer";
          del.style.fontWeight = "800";
          del.style.background = "rgba(229,57,53,0.85)";
          del.style.color = "white";

          del.onclick = (e) => {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            if (window.L?.DomEvent) L.DomEvent.stop(e);
            removeLink(marker, l.target);
          };

          row.appendChild(del);
          linksList.appendChild(row);
        });
      }

      const linkBtn = document.createElement("button");
      linkBtn.type = "button";
      linkBtn.innerText = "Link to another marker (click target)";
      linkBtn.style.width = "100%";
      linkBtn.style.padding = "10px";
      linkBtn.style.borderRadius = "10px";
      linkBtn.style.border = "none";
      linkBtn.style.cursor = "pointer";
      linkBtn.style.fontWeight = "800";
      linkBtn.style.background = "rgba(255,255,255,0.12)";
      linkBtn.style.color = "white";
      linkBtn.style.marginTop = "8px";

      linkBtn.onclick = (e) => {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        if (window.L?.DomEvent) L.DomEvent.stop(e);

        window.GG_LINKING_FROM = marker;
        toast(`Link mode: click the target marker for "${marker.options.title}" (Esc to cancel)`);
        map.closePopup(); // optional: gives you a clear view to click the target
      };
      editWrap.appendChild(linkBtn);
    
      // --- Delete button ---
      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "Delete Marker";
      deleteBtn.style.width = "100%";
      deleteBtn.style.padding = "10px";
      deleteBtn.style.borderRadius = "10px";
      deleteBtn.style.border = "none";
      deleteBtn.style.cursor = "pointer";
      deleteBtn.style.fontWeight = "800";
      deleteBtn.style.background = "#e53935";
      deleteBtn.style.color = "white";
      deleteBtn.style.marginTop = "8px";

      deleteBtn.onclick = () => {
        if (!confirm(`Delete this marker?\n\n${id}`)) return;
        deleteMarkerEverywhere(id);
      };
      editWrap.appendChild(deleteBtn);

      // --- Save button ---
      const saveBtn = document.createElement("button");
      saveBtn.innerText = "Save Edits";
      saveBtn.style.width = "100%";
      saveBtn.style.padding = "10px";
      saveBtn.style.borderRadius = "10px";
      saveBtn.style.border = "none";
      saveBtn.style.cursor = "pointer";
      saveBtn.style.fontWeight = "700";
      saveBtn.style.background = "#673ab7";
      saveBtn.style.color = "white";

      saveBtn.addEventListener("click", (e) => {
        // Prevent Leaflet/map from treating this as a map click / marker click
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }
        // Leaflet helper (extra-safe)
        if (window.L && L.DomEvent) L.DomEvent.stop(e);

        applyEditsToMarker(marker, id, {
          id: idInput.value.trim(),
          name: nameInput.value.trim(),
          category: catSelect.value,
          iconKey: iconSelect.value,
          description: descInput.value,
          image: imgInput.value,
          locked: lockInput.checked,
          mp4: mp4Input.value,
        });

        // Close the currently open popup (most reliable)
        setTimeout(() => {
          map.closePopup();
          // optional: also ensure the marker’s popup closes
          marker.closePopup();
        }, 0);
      });

      editWrap.appendChild(saveBtn);
      popupContainer.appendChild(editWrap);
    }
    if (marker.image) {
      const img = document.createElement("img");
      img.src = marker.image;
      img.alt = marker.options.title || "";
      img.loading = "lazy";

      img.style.width = "100%";
      img.style.marginTop = "8px";
      img.style.borderRadius = "6px";
      img.style.display = "block";

      popupContainer.appendChild(img);
    }

    if (marker.mp4) {
      const video = document.createElement("video");
      video.dataset.src = marker.mp4;   // 👈 lazy-load
      video.muted = true;
      video.loop = true;
      video.playsInline = true;
      video.preload = "none";            // 👈 important

      video.style.width = "100%";
      video.style.marginTop = "8px";
      video.style.borderRadius = "6px";
      video.style.display = "block";

      popupContainer.appendChild(video);

      // Load + play ONLY when popup opens
      marker.on("popupopen", () => {
        if (!video.src) {
          video.src = video.dataset.src;
          video.load();
        }
        video.play().catch(() => {});
      });

      // Pause when popup closes
      marker.on("popupclose", () => {
        video.pause();
      });
    }

    if (marker.links.length > 0) {
      const linkHeader = document.createElement("div");
      linkHeader.style.fontSize = "13px";
      linkHeader.style.marginBottom = "6px";
      linkHeader.style.opacity = "0.8";
      linkHeader.innerText = "Related:";
      popupContainer.appendChild(linkHeader);

      marker.links.forEach(link => {
        const a = document.createElement("div");
        a.innerText = "➜ " + link.label;
        a.style.cursor = "pointer";
        a.style.color = "#9c7cff";
        a.style.fontSize = "14px";
        a.style.marginBottom = "4px";
        a.style.textDecoration = "underline";

        a.onclick = () => jumpToMarker(link.target, link.zoom);

        popupContainer.appendChild(a);
      });
    }

    // Horizontal line
    const hr = document.createElement("hr");
    hr.style.border = "none";
    hr.style.borderTop = "1px solid rgba(255,255,255,0.1)";
    hr.style.margin = "6px 0";
    popupContainer.appendChild(hr);

    // Found checkbox
    const label = document.createElement("label");
    label.className = "popup-toggle";
    label.innerText = "Found ";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = isFound;
    input.addEventListener("change", e => toggleFound(marker.__id, e.target));

    label.appendChild(input);
    popupContainer.appendChild(label);

    // Bind popup
    marker.unbindPopup();
    marker.bindPopup(popupContainer, {
      maxWidth: 520,
      minWidth: 420,
      className: "popup-dark"
    });

    marker.on('popupopen', e => {
      const container = e.popup._container;
      if (container) container.classList.add('popup-dark');
    });

    marker.on("popupclose", () => {
      const video = popupContainer.querySelector("video");
      if (video) video.pause();
    });

    marker.on("popupopen", () => {
      if (window.GG_EDIT_MODE) window.GG_SELECTED_MARKER = marker;
    });
  }

  document.getElementById('resetProgress').onclick = async () => {
  if (!confirm("Are you sure you want to reset all progress?")) return;

  // Clear localStorage
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith("found_")) localStorage.removeItem(key);
  });

  // Reset all found markers
  for (const id in foundMarkers) {
    const marker = foundMarkers[id];

    marker.isFound = false;
    marker.setIcon(createSvgMarker(marker.category, false, marker.iconKey, !!marker.isLocked));

    markers[id] = marker;
  }

  // Clear foundMarkers object
  Object.keys(foundMarkers).forEach(id => delete foundMarkers[id]);

  updateMarkersByCategory();
  updateProgressDisplay();

  // Reset Firebase if logged in
  if (isLoggedIn && auth.currentUser) {
    try {
      const ref = doc(db, "users", auth.currentUser.uid, "progress", "foundMarkers");
      await setDoc(ref, { found: [] });
    } catch (err) {
      console.error("Firebase reset failed:", err);
    }
  }

  // Rebuild popups so checkbox reflects reset state
    Object.values(markers).forEach(marker => {
    createMarkerPopup(marker, marker.__id);
    });
};

</script>

</body>
</html>
