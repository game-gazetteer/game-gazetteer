<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Game Gazetteer - Cuphead Interactive Map</title>
  <link rel="icon" type="image/png" href="icons/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>

    .leaflet-container img.leaflet-tile {
        mix-blend-mode: normal;
        width: 256px !important;
        height: 256px !important;
    }

    /* Remove the default popup close button */
    .leaflet-popup-close-button {
    display: none;
    }

    /* Dark mode popup styles */
    .popup-dark .leaflet-popup-content-wrapper {
    background: rgba(30,30,30,0.95) !important;
    color: #ddd;
    border-radius: 8px;
    box-shadow: none;
    border: none;
    }

    .popup-dark .leaflet-popup-tip {
    background: rgba(30,30,30,0.95) !important;
    border: none;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
    }

    #map { 
      width: 100%; height: 100%; 
      background: #c0dce0;
    }

    /* SIDEBAR */
    #controls {
      position: absolute;
      top: 60px; /* moved down from 20px */
      left: 20px;
      width: 260px;
      max-height: calc(100vh - 80px);
      background: rgba(20,20,20,0.85);
      color: #eee;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 2000;
      display: block;

      overflow-y: auto;  /* enable vertical scrolling */
      scrollbar-width: thin; /* for Firefox */
      scrollbar-color: rgba(255,255,255,0.3) transparent;
    }

    #controls::-webkit-scrollbar {
      width: 8px;
    }

    #controls::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.3);
      border-radius: 4px;
    }

    #controls::-webkit-scrollbar-track {
      background: transparent;
    }

    /* SIDEBAR TOGGLE */
    #toggleSidebar {
      position: absolute;
      top: 20px; /* stays above the sidebar */
      left: 20px;
      z-index: 3000;
      background: rgba(20,20,20,0.85);
      border: none;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toggleSidebar svg {
    display: block;
    }

    #controls h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 600;
    }

    .subcategory { margin-top: 14px; }

    .subcategory h3 {
      margin: 0 0 8px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    .filter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.05);
      padding: 6px 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .filter-item:hover {
      background: rgba(255,255,255,0.12);
    }

    .filter-icon {
      width: 22px;
      height: 22px;
      fill: white;
      flex-shrink: 0;
    }

    .filter-item span {
      flex-grow: 1;
      margin-left: 10px;
      font-size: 14px;
    }

    /* Toggle Switch (sidebar) */
    .filter-item input[type="checkbox"] {
      appearance: none;
      width: 36px;
      height: 18px;
      background: #555;
      border-radius: 9px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: 0.2s;
    }
    .filter-item input[type="checkbox"]::after {
      content: "";
      width: 14px;
      height: 14px;
      background: #ccc;
      position: absolute;
      top: 2px;
      left: 2px;
      border-radius: 50%;
      transition: 0.2s;
    }
    .filter-item input[type="checkbox"]:checked {
      background: #4caf50;
    }
    .filter-item input[type="checkbox"]:checked::after {
      left: 20px;
      background: white;
    }

    #foundToggle {
      margin-top: 18px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #673ab7;
      color: white;
      font-size: 14px;
    }

    #progressBox {
      background: rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }

    #progressBox h3 {
      margin: 0 0 6px;
      font-size: 16px;
      color: #fff;
    }

    #progressDetails {
      font-size: 14px;
      opacity: 0.9;
    }

    #progressDetailsContainer.centered {
      justify-content: center; /* center the text when star is hidden */
    }

    /* Progress bar container */
    #progressBarOuter {
      width: 100%;
      height: 14px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      overflow: hidden;
      margin: 8px 0 10px 0;
    }

    /* Animated filling bar */
    #progressBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #9c7cff, #673ab7);
      transition: width 0.35s ease;
      border-radius: 8px;
    }

    #progressStar {
      font-size: 20px;
      filter: drop-shadow(0 0 4px gold);
      display: inline-block; /* will toggle to none in JS */
      transition: transform 0.4s cubic-bezier(.3,1.5,.7,1);
    }

    /* Popup toggle switch */
    .popup-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 6px;
    }
    .popup-toggle input[type="checkbox"] {
      appearance: none;
      width: 28px;
      height: 14px;
      background: #555;
      border-radius: 7px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: 0.2s;
    }
    .popup-toggle input[type="checkbox"]::after {
      content: "";
      width: 12px;
      height: 12px;
      background: #2196F3; /* blue toggle */
      position: absolute;
      top: 1px;
      left: 1px;
      border-radius: 50%;
      transition: 0.2s;
    }
    .popup-toggle input[type="checkbox"]:checked {
      background: #2196F3;
    }
    .popup-toggle input[type="checkbox"]:checked::after {
      left: 15px;
      background: white;
    }

    .collapsible-header {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .subcategory-content {
      overflow: hidden;
      max-height: 500px;
      transition: max-height 0.25s ease;
    }

    .subcategory.collapsed .subcategory-content {
      max-height: 0;
    }

    /* ------------------------------
      MOBILE RESPONSIVE SIDEBAR
    --------------------------------*/
    @media (max-width: 768px) {
      #controls {
        width: 70%;             /* shrinks sidebar */
        left: 10px;
        top: 70px;
        padding: 14px;
        border-radius: 12px;
        font-size: 14px;
      }

      #toggleSidebar {
        top: 10px;
        left: 10px;
        padding: 6px;
        transform: scale(0.9);
      }

      #controls h2 {
        font-size: 18px;
      }

      .subcategory h3 {
        font-size: 14px;
      }

      .filter-item span {
        font-size: 13px;
      }

      .filter-item {
        padding: 4px 6px;
      }

      #foundToggle,
      #resetProgress,
      #showAllBtn,
      #hideAllBtn {
        font-size: 13px;
        padding: 8px;
      }

      #markerSearch {
        font-size: 13px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      #controls {
        width: 85%;
        padding: 12px;
        left: 8px;
        top: 65px;
      }

      #toggleSidebar {
        transform: scale(0.8);
      }

      .filter-item {
        padding: 4px 5px;
      }
    }

  </style>
</head>

<body>

<button id="toggleSidebar" title="Toggle Sidebar">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="3" y1="6" x2="21" y2="6"/>
    <line x1="3" y1="12" x2="21" y2="12"/>
    <line x1="3" y1="18" x2="21" y2="18"/>
  </svg>
</button> 

<div id="controls">

  <a href="https://www.gamegazetteer.com" id="gazetteerBtn" style="
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: white;
    padding: 4px 0px;
    border-radius: 8px;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 28px;
    font-family: 'Cinzel', serif;
  ">
    <img src="icons/favicon.png" alt="Logo" style="width:32px; height:32px;">
    Game Gazetteer
  </a>



  <input type="text" id="markerSearch" placeholder="Search..." style="
    width: calc(100% - 16px);
    padding: 6px 8px;
    border-radius: 6px;
    border: none;
    outline: none;
    font-size: 14px;
    margin-bottom: 10px;
    display: block;
  ">

  <div id="toggleAllContainer" style="display:flex; gap:8px; margin-top:10px;">
      <button id="showAllBtn" style="
          flex:1;
          padding:8px;
          border:none;
          border-radius:8px;
          cursor:pointer;
          background: #673ab7;  /* same purple */
          color:white;
          font-size:14px;
      ">Show All</button>

      <button id="hideAllBtn" style="
          flex:1;
          padding:8px;
          border:none;
          border-radius:8px;
          cursor:pointer;
          background: #673ab7;  /* same purple */
          color:white;
          font-size:14px;
      ">Hide All</button>
  </div>

  <!-- ENEMIES -->
  <div class="subcategory">
    <h3 class="collapsible-header">Enemies</h3>
      <div class="subcategory-content">

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2C7 2 3 6 3 11c0 3 2 5 4 6v3a2 2 0 0 0 2 2h1v-4h4v4h1a2 2 0 0 0 2-2v-3c2-1 4-3 4-6 0-5-4-9-9-9zm-3 9a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm6 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
          <span>Bosses</span>
          <input type="checkbox" class="category" value="Boss" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M13 2l4 4-3 3 7 7-3 3-7-7-3 3-4-4z"/></svg>
          <span>Run 'n Gun</span>
          <input type="checkbox" class="category" value="RunGun" checked>
        </label>
      </div>
  </div>

  <!-- COLLECTIBLES -->
  <div class="subcategory">
    <h3 class="collapsible-header">Collectibles</h3>
      <div class="subcategory-content">

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4.5L18 22l-6-4-6 4 1.5-8.5L2 9h7z"/></svg>
          <span>Weapons / Charms</span>
          <input type="checkbox" class="category" value="Items" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1"/>
            <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          <span>Coins</span>
          <input type="checkbox" class="category" value="Coins" checked>
        </label>
      </div>
  </div>

  <!-- POINTS OF INTEREST -->
  <div class="subcategory">
    <h3 class="collapsible-header">Points of Interest</h3>
      <div class="subcategory-content">

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M3 18l9 3 9-3v-3H3zm9-13l6 5v4H6v-4z"/></svg>
          <span>The Boatman</span>
          <input type="checkbox" class="category" value="Travel" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 12c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>
          <span>NPCs</span>
          <input type="checkbox" class="category" value="NPC" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- Mausoleum roof -->
            <path d="M4 10 L12 2 L20 10" />
            <!-- Walls -->
            <rect x="6" y="10" width="12" height="10" rx="2" ry="2" />
            <!-- Arched doorway -->
            <path d="M10 20 V14 a2 2 0 0 1 4 0 V20" />
            <!-- Optional stylized cross on top -->
            <line x1="12" y1="0" x2="12" y2="2" />
            <line x1="11" y1="1" x2="13" y2="1" />
          </svg>
          <span>Mausoleums</span>
          <input type="checkbox" class="category" value="Maus" checked>
        </label>

        <label class="filter-item">
          <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 0 14v2h-2v-4h2a5 5 0 1 0-5-5H5a7 7 0 0 1 7-7zm0 18a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"/></svg>
          <span>Secrets</span>
          <input type="checkbox" class="category" value="Secrets" checked>
        </label>
      </div>
  </div>

  <!-- PROGRESS COUNTER (moved to bottom) -->
  <div id="progressBox">
    <h3>Progress</h3>

    <div id="progressBarOuter">
      <div id="progressBarInner"></div>
    </div>

    <div id="progressDetailsContainer" style="display:flex; align-items:center; justify-content:center; gap:6px; margin-top:4px;">
      <div id="progressDetails">0 / 0 (0%)</div>
      <div id="progressStar">⭐</div>
    </div>

  </div>

  <button id="foundToggle">Hide Found Items</button>

  <button id="resetProgress" style="
    margin-top: 10px;
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #e53935; /* red */
    color: white;
    font-size: 14px;
  ">Reset Progress</button>

</div>

<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ---------- MARKER ICONS ---------- */
const icons = {
  "Boss": L.icon({ 
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "Maus": L.icon({ 
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "RunGun": L.icon({ 
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "Items": L.icon({ 
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "Coins": L.icon({ 
    iconUrl: 'icons/coin.png',
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "Travel": L.icon({ 
    iconUrl: 'icons/boatman.png',
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "NPC": L.icon({ 
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  }),
  "Secrets": L.icon({ 
    iconUrl: 'icons/secret.png',
    iconSize: [48, 72], 
    iconAnchor: [24, 72], 
    popupAnchor: [0, -72] 
  })
};

/* ---------- MAP ---------- */
var map = L.map('map', { 
  center: [27, 36],
  zoom: 2,
  zoomControl: false,
  attributionControl: false
});

L.tileLayer('tiles/{z}/{x}/{y}.png', {
    maxZoom: 5, 
    minZoom: 2,
    noWrap: true,
    bounds: [[-75.5,-180],[85.04,259.5]]
}).addTo(map);

const markers = {};
const foundMarkers = {};
let hideFound = false;

let totalCount = 0;

/* ---------- PROGRESS COUNTER UPDATER ---------- */
function updateProgressDisplay() {
  const foundCount = Object.keys(foundMarkers).length;
  const percent = totalCount > 0 ? Math.round((foundCount / totalCount) * 100) : 0;

  document.getElementById("progressDetails").innerText =
    `${foundCount} / ${totalCount} (${percent}%)`;

  // Update progress bar width
  document.getElementById("progressBarInner").style.width = percent + "%";

  // Handle 100% star
  const star = document.getElementById("progressStar");

  if (percent === 100) {
    star.style.display = "inline-block"; // show star
    star.style.opacity = "1";
    star.style.transform = "scale(1)";
  } else {
    star.style.display = "none"; // remove star from layout
  }
}

/* ---------- HELPER FUNCTIONS ---------- */

// Make sidebar subcategories collapsible
document.querySelectorAll('.subcategory').forEach(section => {
  const header = section.querySelector('h3');
  const content = section.querySelector('.subcategory-content');

  // Start expanded
  section.classList.remove("collapsed");

  header.addEventListener('click', () => {
    section.classList.toggle("collapsed");
  });
});

const searchInput = document.getElementById('markerSearch');
const searchResults = document.getElementById('searchResults');

function updateSearchResults() {
  const query = searchInput.value.toLowerCase();
  searchResults.innerHTML = '';

  if (!query) return;

  const allMarkers = {...markers, ...foundMarkers};

  Object.entries(allMarkers).forEach(([id, marker]) => {
    if (marker.options.title.toLowerCase().includes(query)) {
      const div = document.createElement('div');
      div.innerText = marker.options.title;
      div.style.cursor = 'pointer';
      div.style.padding = '4px 6px';
      div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
      div.onclick = () => {
        map.setView(marker.getLatLng(), 0); // zoom/pan to marker
        marker.openPopup();
      };
      searchResults.appendChild(div);
    }
  });
}

searchInput.addEventListener('input', updateSearchResults);

/* ---------- HIDE/SHOW FOUND ---------- */
document.getElementById("foundToggle").onclick = () => {
  hideFound = !hideFound;

  if (hideFound) {
    Object.values(foundMarkers).forEach(m => map.removeLayer(m));
    foundToggle.innerText = "Show Found Items";
  } else {
    Object.values(foundMarkers).forEach(m => m.addTo(map));
    foundToggle.innerText = "Hide Found Items";
  }
};

/* ---------- SHOW ALL / HIDE ALL CATEGORY TOGGLES ---------- */
document.getElementById("showAllBtn").onclick = () => {
  document.querySelectorAll('.category').forEach(box => box.checked = true);
  updateMarkersByCategory();
};

document.getElementById("hideAllBtn").onclick = () => {
  document.querySelectorAll('.category').forEach(box => box.checked = false);
  updateMarkersByCategory();
};

/* ---------- CATEGORY FILTERING ---------- */
function updateMarkersByCategory() {
  const active = [...document.querySelectorAll('.category:checked')].map(x => x.value);

  [...Object.values(markers), ...Object.values(foundMarkers)].forEach(m => {
    if (active.includes(m.category) && !(hideFound && Object.values(foundMarkers).includes(m))) {
      m.addTo(map);
    } else {
      map.removeLayer(m);
    }
  });
}

document.querySelectorAll('.category').forEach(b => {
  b.addEventListener('change', updateMarkersByCategory);
});

function updateMarkersBySearch() {
  const query = searchInput.value.toLowerCase();
  const activeCategories = [...document.querySelectorAll('.category:checked')].map(x => x.value);

  [...Object.values(markers), ...Object.values(foundMarkers)].forEach(marker => {
    const matchesCategory = activeCategories.includes(marker.category);
    
    // Check if query is in title or description
    const titleMatch = marker.options.title.toLowerCase().includes(query);
    const descMatch = marker.description && marker.description.toLowerCase().includes(query);
    const matchesSearch = titleMatch || descMatch;

    if (matchesCategory && matchesSearch && !(hideFound && Object.values(foundMarkers).includes(marker))) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
    }
  });
}

// Run live search whenever input changes
searchInput.addEventListener('input', updateMarkersBySearch);

// Make category filtering also respect search
function updateMarkersByCategoryAndSearch() {
  updateMarkersBySearch();
}

// Update category event listener
document.querySelectorAll('.category').forEach(b => {
  b.addEventListener('change', updateMarkersByCategoryAndSearch);
});

// Log click coords rounded to 1 decimal place
map.on('click', e => {
  const lat = e.latlng.lat.toFixed(2);
  const lng = e.latlng.lng.toFixed(1);
  console.log(`Clicked at: ${lat}, ${lng}`);
});

</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

  // Firebase config
  const firebaseConfig = {
      apiKey: "AIzaSyBGI-tSZjsy7wvNSu3D_lFZR96TQND-uJU",
      authDomain: "gamegazetteer-bfed2.firebaseapp.com",
      projectId: "gamegazetteer-bfed2",
      storageBucket: "gamegazetteer-bfed2.appspot.com",
      messagingSenderId: "659845857638",
      appId: "1:659845857638:web:7ad66baffa924961a948a7",
      measurementId: "G-Q8QP2RD1BL"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  // const analytics = getAnalytics(app);
  const auth = getAuth();
  const db = getFirestore();

  let isLoggedIn = false;

  // Check Logged in
  onAuthStateChanged(auth, async user => {

    let foundIds = [];

    if (user) {
        isLoggedIn = true
        console.log("User logged in → loading Firebase progress");

        // LOAD from Firebase
        console.log("Auth state:", user?.uid);
        console.log("Calling Firebase loader...");
        foundIds = await loadFoundMarkersFromFirebase(user);
        console.log("Loaded foundIds:", foundIds);
        console.log("Reached FETCH block");
    } else {
        isLoggedIn = false
        console.log("Not logged in → using localStorage");

        foundIds = Object.keys(localStorage)
            .filter(k => k.startsWith("found_") && localStorage.getItem(k) === "true")
            .map(k => k.replace("found_", ""));
    }

      /* ---------- LOAD MARKERS ---------- */
      console.log("Reached FETCH block");
      fetch('markers.json')
        .then(res => res.json())
        .then(data => {

          totalCount = data.length;

          data.forEach(point => {
            const id = String(point.id);
            const isFound = foundIds.includes(id);

            const baseIcon = icons[point.category] || L.icon({
                iconSize: [48, 72],
                iconAnchor: [24, 72],
                popupAnchor: [0, -72]
            });

            let iconToUse = baseIcon;

            // Override with a custom image if provided
            if (point.icon) {
                iconToUse = L.icon({
                    iconUrl: point.icon,
                    iconSize: baseIcon?.options?.iconSize ?? [48,72],
                    iconAnchor: baseIcon?.options?.iconAnchor ?? [24,72],
                    popupAnchor: baseIcon?.options?.popupAnchor ?? [0,-72]
                });
            }

            /* ============================
                CREATE MARKER
                ============================ */

            const marker = L.marker(point.coords, {
                opacity: isFound ? 0.5 : 1,
                icon: iconToUse,
                title: point.name
            });

            marker.category = point.category;
            marker.description = point.description;
            marker.isFound = isFound;

            if (isFound) {
              foundMarkers[point.id] = marker;
            } else {
              markers[point.id] = marker;
            }
              
            marker.addTo(map);
            createMarkerPopup(marker, point.id);

            // RIGHT-CLICK TO TOGGLE FOUND WITHOUT SHOWING POPUP
            marker.on("contextmenu", async (e) => {
              e.originalEvent.preventDefault(); // stop browser right-click menu
              const id = point.id;
              const isNowFound = !foundIds.includes(String(id));

              // Toggle state
              if (isNowFound) {
                foundIds.push(String(id));
                marker.setOpacity(0.5);
                delete markers[id];
                foundMarkers[id] = marker;
              } else {
                foundIds = foundIds.filter(x => x !== String(id));
                marker.setOpacity(1);
                delete foundMarkers[id];
                markers[id] = marker;
              }

              // SAVE depending on logged in status
              if (isLoggedIn && user) {
                await saveFoundMarkersToFirebase(user, foundIds);
              } else {
                if (isNowFound) localStorage.setItem(`found_${id}`, "true");
                else localStorage.removeItem(`found_${id}`);
              }

              updateMarkersByCategory();
              updateProgressDisplay();

              marker.addTo(map);
              createMarkerPopup(marker, point.id);
            });

          });

          updateProgressDisplay();
        });
  });
  console.log("Loaded JSON:", data);
  console.log("Data length:", data.length);

  // LOAD found markers from Firebase
  async function loadFoundMarkersFromFirebase(user) {
    try {
        const ref = doc(db, "users", user.uid, "progress", "foundMarkers");
        const snap = await getDoc(ref);

        if (!snap.exists()) return [];

        const found = snap.data().found;

        return Array.isArray(found) ? found : [];
    } 
    catch (err) {
        console.error("FIREBASE READ ERROR:", err);
        return [];
    }
  }


  // SAVE found markers TO Firebase
  async function saveFoundMarkersToFirebase(user, foundIdsArray) {
      const ref = doc(db, "users", user.uid, "progress", "foundMarkers");
      await setDoc(ref, { found: foundIdsArray });
  }

  /* ---------- SIDEBAR TOGGLE ---------- */
  document.getElementById("toggleSidebar").onclick = () => {
    const side = document.getElementById("controls");
    side.style.display = side.style.display === "none" ? "block" : "none";
  };

  async function toggleFound(id, checkbox) {
    const marker = markers[id] || foundMarkers[id];
    if (!marker) return;

    const isNowFound = checkbox.checked;
    marker.isFound = isNowFound;

    if (isNowFound) {
      marker.setOpacity(0.5);
      delete markers[id];
      foundMarkers[id] = marker;
    } else {
      marker.setOpacity(1);
      delete foundMarkers[id];
      markers[id] = marker;
    }

    if (isLoggedIn && auth.currentUser) {
      // update foundIds array
      let foundIds = Object.keys(foundMarkers);
      if (isNowFound && !foundIds.includes(String(id))) foundIds.push(String(id));
      if (!isNowFound) foundIds = foundIds.filter(x => x !== String(id));

      await saveFoundMarkersToFirebase(auth.currentUser, foundIds);
    } else {
      // fallback to localStorage
      if (isNowFound) localStorage.setItem(`found_${id}`, "true");
      else localStorage.removeItem(`found_${id}`);
    }

    updateMarkersByCategory();
    updateProgressDisplay();

    createMarkerPopup(marker, id);
    marker.openPopup();
  }

  function createMarkerPopup(marker, id) {
    const isFound = marker.isFound;

    // Create container div
    const popupContainer = document.createElement("div");
    popupContainer.style.fontFamily = "'Segoe UI', sans-serif";
    popupContainer.style.minWidth = "220px";
    popupContainer.style.color = "#fff";
    popupContainer.style.padding = "10px";

    // Title
    const title = document.createElement("h3");
    title.style.margin = "0 0 6px 0";
    title.style.fontSize = "20px";
    title.style.color = "#9c7cff";
    title.innerText = marker.options.title;
    popupContainer.appendChild(title);

    // Description
    if (marker.description) {
      const desc = document.createElement("p");
      desc.style.margin = "0 0 10px 0";
      desc.style.fontSize = "14px";
      desc.style.lineHeight = "1.4";
      desc.style.color = "#fff";
      desc.innerText = marker.description;
      popupContainer.appendChild(desc);
    }

    // Horizontal line
    const hr = document.createElement("hr");
    hr.style.border = "none";
    hr.style.borderTop = "1px solid rgba(255,255,255,0.1)";
    hr.style.margin = "6px 0";
    popupContainer.appendChild(hr);

    // Found checkbox
    const label = document.createElement("label");
    label.className = "popup-toggle";
    label.innerText = "Found ";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = isFound;
    input.addEventListener("change", e => toggleFound(id, e.target));

    label.appendChild(input);
    popupContainer.appendChild(label);

    // Bind popup
    marker.unbindPopup();
    marker.bindPopup(popupContainer);

    marker.on('popupopen', e => {
      const container = e.popup._container;
      if (container) container.classList.add('popup-dark');
    });
  }

  document.getElementById('resetProgress').onclick = async () => {
    if (!confirm("Are you sure you want to reset all progress?")) return;

    // Clear found markers from localStorage
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith("found_")) localStorage.removeItem(key);
    });

    // Reset marker states
    Object.values(foundMarkers).forEach(marker => {
      marker.setOpacity(1);
      markers[marker.options.title] = marker; // put back into markers (optional)
    });

    // Clear foundMarkers object
    for (const id in foundMarkers) delete foundMarkers[id];

    // Update map and progress display
    updateMarkersByCategory();
    updateProgressDisplay();

    // ----- Reset Firebase ONLY if logged in -----
    if (isLoggedIn && auth.currentUser) {
      try {
        const ref = doc(db, "users", auth.currentUser.uid, "progress", "foundMarkers");
        await setDoc(ref, { found: [] });
        console.log("Firebase progress reset successfully.");
      } catch (err) {
        console.error("Error resetting Firebase progress:", err);
      }
    }
  };

</script>

</body>
</html>
